<!-- START OF FILE dataset_analysis.html -->
{% extends "layout.html" %}

{% block head %}
<style>
    /* ==================== ABYSSAL TELEMETRY ANALYSIS STYLES ==================== */

    /* Chart Containers */
    .chart-container {
        position: relative;
        height: 350px;
        width: 100%;
        border: 1px solid var(--border-color);
        background: rgba(0,0,0,0.3);
    }

    /* HUD Card Header Override */
    .card-header {
        background: rgba(255, 255, 255, 0.05);
        border-bottom: 1px solid var(--border-color);
        font-family: 'Orbitron', sans-serif;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--color-primary);
        font-size: 0.85rem;
        padding: 0.75rem 1rem;
    }

    /* Gallery Grid */
    #gallery {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 2px; /* Tight gap for grid look */
        max-height: 80vh;
        overflow-y: auto;
        padding: 2px;
        background-color: var(--bg-body);
        border: 1px solid var(--border-color);
    }

    #gallery .gallery-item {
        position: relative;
        background-color: #000;
        border: 1px solid var(--border-color);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        transition: border-color 0.1s;
    }

    #gallery .gallery-item:hover {
        border-color: var(--color-primary);
        z-index: 10;
        box-shadow: 0 0 10px var(--color-primary-dim);
    }

    #gallery img {
        width: 100%;
        height: 150px;
        object-fit: cover;
        display: block;
        cursor: pointer;
        filter: grayscale(20%); /* Slight desat for industrial look */
        transition: filter 0.2s;
    }
    #gallery .gallery-item:hover img {
        filter: grayscale(0%);
    }

    #gallery .gallery-item.hidden { display: none; }

    #gallery .caption {
        background: rgba(0,0,0,0.8);
        padding: 0.5rem;
        font-size: 0.7rem;
        text-align: left;
        border-top: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        font-family: 'JetBrains Mono', monospace;
    }

    .caption-text {
        color: var(--text-main);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* Loading State */
    #loading-indicator {
        height: 60vh;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        color: var(--color-primary);
        font-family: 'Orbitron';
    }

    /* Augmentation Previewer */
    #aug-preview-gallery {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 10px;
    }
    #aug-preview-gallery img {
        width: 100%;
        border: 1px solid var(--border-color);
        opacity: 0.8;
        transition: opacity 0.2s;
    }
    #aug-preview-gallery img:hover {
        opacity: 1;
        border-color: var(--color-primary);
    }

    .aug-preview-source-img {
        width: 80px;
        height: 60px;
        object-fit: cover;
        border: 1px solid var(--border-color);
        cursor: pointer;
        opacity: 0.5;
        transition: all 0.2s;
    }
    .aug-preview-source-img.active, .aug-preview-source-img:hover {
        opacity: 1;
        border-color: var(--color-primary);
        box-shadow: 0 0 5px var(--color-primary-glow);
    }

    #preview-aug-controls {
        max-height: 500px;
        overflow-y: auto;
        padding-right: 10px;
    }

    /* Summary Alerts */
    .summary-alert {
        background: rgba(0, 240, 255, 0.05);
        border: 1px solid var(--color-primary);
        color: var(--text-main);
        font-family: 'JetBrains Mono';
        padding: 1rem;
        margin-bottom: 1rem;
    }

    .warning-item {
        background: rgba(255, 208, 0, 0.05);
        border-left: 3px solid var(--color-warning);
        color: #ddd;
        font-family: 'JetBrains Mono';
        padding: 0.5rem;
        margin-bottom: 0.25rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid content-wrapper fade-in">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-end mb-4 pb-2 border-bottom border-secondary">
         <div>
            <h3 class="mb-0 text-uppercase" style="font-family: 'Orbitron'; color: var(--text-main); letter-spacing: 0.1em;">DATASET ANALYSIS</h3>
            <p class="mb-0 text-muted font-monospace small">> {{ dataset.description }}</p>
        </div>
        <a href="/" class="btn btn-outline-secondary text-uppercase btn-sm rounded-0">
            <i class="bi bi-chevron-left"></i> Return to Base
        </a>
    </div>

    <!-- Loading State -->
    <div id="loading-indicator">
        <div class="spinner-border mb-3" role="status" style="width: 3rem; height: 3rem; border-width: 2px;"></div>
        <h4 class="text-uppercase" style="letter-spacing: 0.2em;">PROCESSING DATA...</h4>
        <p class="text-muted font-monospace small">CALCULATING STATISTICS // GENERATING PREVIEWS</p>
    </div>

    <!-- Main Content -->
    <div id="analysis-content" style="display: none;">

        <!-- Summary Card -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-terminal mr-2"></i> SYSTEM_DIAGNOSTICS
            </div>
            <div class="card-body">
                <div id="summary-container"></div>

                <div id="consistency-check-container" class="mt-4 pt-3 border-top border-secondary">
                    <h6 class="font-weight-bold mb-2 text-uppercase text-info"><i class="bi bi-cpu mr-1"></i> AI Consistency Scan</h6>
                    <p class="text-muted small mb-3 font-monospace">Detect anomalies using embedding vectors.</p>

                    <div class="d-flex align-items-center flex-wrap">
                        <div class="custom-control custom-switch mr-4 mb-2">
                            <input type="checkbox" class="custom-control-input" id="enable-color-check" checked>
                            <label class="custom-control-label font-weight-bold small text-uppercase text-muted" for="enable-color-check">Strict Color Check</label>
                        </div>
                        <button class="btn btn-sm btn-primary rounded-0 text-uppercase" id="run-consistency-check-btn">
                            <i class="bi bi-search mr-1"></i> Initiate Scan
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row 1 -->
        <div class="row">
            <div class="col-lg-4 mb-4">
                <div class="card h-100">
                    <div class="card-header">INSTANCE DISTRIBUTION</div>
                    <div class="card-body p-0">
                        <div class="chart-container border-0"><canvas id="class-counts-chart"></canvas></div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 mb-4">
                <div class="card h-100">
                    <div class="card-header">OBJECT DENSITY</div>
                    <div class="card-body p-0">
                        <div class="chart-container border-0"><canvas id="objects-per-image-chart"></canvas></div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 mb-4">
                <div class="card h-100">
                    <div class="card-header">LUMINOSITY SPECTRUM</div>
                    <div class="card-body p-0">
                        <div class="chart-container border-0"><canvas id="brightness-chart"></canvas></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row 2 -->
        <div class="row">
             <div class="col-lg-4 mb-4">
                 <div class="card h-100">
                     <div class="card-header">ASPECT RATIO</div>
                     <div class="card-body p-0">
                         <div class="chart-container border-0"><canvas id="aspect-ratio-chart"></canvas></div>
                     </div>
                 </div>
             </div>
            <div class="col-lg-8 mb-4">
                <div class="card h-100">
                    <div class="card-header">SPATIAL HEATMAP</div>
                    <div class="card-body p-0">
                        <div id="bbox-heatmap-container" class="chart-container border-0">
                            <canvas id="bbox-center-scatter-plot"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Augmentation Previewer -->
        <div class="row">
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-sliders mr-2"></i> AUGMENTATION SIMULATION
                    </div>
                    <div class="card-body p-0">
                        <div class="row no-gutters">
                            <!-- Left: Controls -->
                            <div class="col-lg-4 border-right border-secondary p-3 bg-dark">
                                <h6 class="font-weight-bold mb-3 border-bottom border-secondary pb-2 text-uppercase text-muted font-monospace small">01 // PARAMETERS</h6>
                                <div id="preview-aug-controls" class="custom-scrollbar">
                                    {% include '_augmentation_controls.html' %}
                                </div>
                            </div>

                            <!-- Right: Preview -->
                            <div class="col-lg-8 p-3">
                                <h6 class="font-weight-bold mb-3 border-bottom border-secondary pb-2 text-uppercase text-muted font-monospace small">02 // LIVE FEED</h6>

                                <div class="mb-3">
                                    <small class="text-muted d-block mb-2 font-weight-bold text-uppercase font-monospace">SOURCE SELECT:</small>
                                    <div id="aug-preview-source-selector" class="d-flex flex-wrap" style="gap: 10px;"></div>
                                </div>

                                <div id="aug-preview-gallery-container" class="border border-secondary p-3" style="min-height: 300px; background: rgba(0,0,0,0.2);">
                                    <div id="aug-preview-gallery"></div>
                                    <div id="aug-preview-loader" class="text-center mt-5" style="display: none;">
                                        <div class="spinner-border text-primary" role="status"></div>
                                        <p class="mt-2 text-primary small font-monospace">RENDERING...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Annotator Stats -->
        <div class="row">
            <div class="col-lg-12 mb-4">
                <div class="card">
                    <div class="card-header">ANNOTATOR PERFORMANCE</div>
                    <div class="card-body p-0">
                        <div class="chart-container border-0"><canvas id="annotator-chart"></canvas></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Image Gallery -->
        <div class="row">
            <div class="col-12">
                 <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
                        <div>
                            <i class="bi bi-grid-3x3 mr-2"></i> DATASET GALLERY
                            <span class="badge badge-secondary ml-2 rounded-0 font-monospace"><span id="gallery-count">0</span> FRAMES</span>
                        </div>

                        <div class="d-flex align-items-center mt-2 mt-md-0">
                            <label class="mr-2 mb-0 small font-weight-bold text-muted text-uppercase">FILTER:</label>
                            <select id="outlier-filter" class="form-control form-control-sm mr-2 rounded-0 bg-black text-white border-secondary" style="width: auto; max-width: 250px;">
                                <option value="none">SHOW_ALL</option>
                                <option value="area_smallest">SMALLEST_OBJECTS (TOP 10)</option>
                                <option value="area_largest">LARGEST_OBJECTS (TOP 10)</option>
                                <option value="ar_smallest">SQUARISH_AR (TOP 10)</option>
                                <option value="ar_largest">EXTREME_AR (TOP 10)</option>
                                <option value="iou_high">HIGH_OVERLAP (IoU > 0.95)</option>
                                <option value="consistency_outliers" style="display: none; color: var(--color-danger); font-weight: bold;">AI_REVIEW_OUTLIERS</option>
                            </select>
                            <button id="reset-filter-btn" class="btn btn-sm btn-outline-secondary rounded-0"><i class="bi bi-x-lg"></i> RESET</button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div id="gallery" class="custom-scrollbar border-0"></div>
                    </div>
                 </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

<script>
$(document).ready(function() {
    const datasetUuid = "{{ dataset.dataset_uuid }}";
    let originalAnalysisData = null;
    let fullGalleryData = [];
    let samplePoolData = [];
    let allBboxesData = [];
    let suspiciousPairsData = [];
    let imageClassMap = {};
    let consistencyOutlierIndices = [];

    let charts = {
        classCounts: null,
        objectsPerImage: null,
        brightness: null,
        aspectRatio: null,
        centerScatter: null,
        annotator: null
    };

    // --- Core Color Palette (Abyssal Telemetry) ---
    // Hardcoded Neon Colors
    function getColor(type) {
        switch (type) {
            case 'primary': return 'rgba(0, 240, 255, 0.6)'; // Cyan
            case 'success': return 'rgba(0, 255, 148, 0.6)'; // Green
            case 'warning': return 'rgba(255, 208, 0, 0.6)'; // Yellow
            case 'info':    return 'rgba(46, 154, 255, 0.6)'; // Blue
            case 'danger':  return 'rgba(255, 42, 42, 0.6)'; // Red
            case 'scatter': return 'rgba(0, 240, 255, 0.8)'; // Bright Cyan
            default:        return '#888';
        }
    }

    // Chart Theme Options (Dark Industrial)
    function getChartThemeOptions() {
        const gridColor = 'rgba(255, 255, 255, 0.05)';
        const textColor = '#888';

        return {
            maintainAspectRatio: false,
            responsive: true,
            plugins: {
                legend: { labels: { color: textColor, font: { family: 'JetBrains Mono' } } },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.9)',
                    titleColor: '#fff',
                    bodyColor: '#ccc',
                    borderColor: 'rgba(0, 240, 255, 0.5)',
                    borderWidth: 1,
                    padding: 10,
                    cornerRadius: 0, // Sharp corners
                    titleFont: { family: 'Orbitron' },
                    bodyFont: { family: 'JetBrains Mono' }
                }
            },
            scales: {
                x: {
                    grid: { color: gridColor },
                    ticks: { color: textColor, font: { family: 'JetBrains Mono' } },
                    title: { display: true, color: textColor, font: { family: 'Orbitron' } }
                },
                y: {
                    beginAtZero: true,
                    grid: { color: gridColor },
                    ticks: { color: textColor, font: { family: 'JetBrains Mono' } },
                    title: { display: true, color: textColor, font: { family: 'Orbitron' } }
                }
            }
        };
    }

    // No need for theme observer, always dark mode

    function updateChartOptions(chart, newOptions) {
        // ... (standard chart update logic)
        chart.update();
    }

    // --- Augmentation Controls Logic ---
    function setupAugmentationListeners(contextSelector) {
        const context = $(contextSelector);
        context.on('input', 'input[type="range"]', function() {
            $(this).closest('div').find('.val-display').text($(this).val());
            if (contextSelector === '#preview-aug-controls') { triggerAugmentationPreview(); }
        });
        context.on('change', '.aug-option input[type="checkbox"]', function() {
            const controlsId = $(this).closest('.aug-option').data('controls');
            context.find('#' + controlsId).toggle($(this).is(':checked'));
            if (contextSelector === '#preview-aug-controls') { triggerAugmentationPreview(); }
        });
        context.find('.aug-option input[type="checkbox"]').each(function() {
            const controlsId = $(this).closest('.aug-option').data('controls');
            context.find('#' + controlsId).toggle($(this).is(':checked'));
        });
    }

    function getAugmentationOptions(isForPreview) {
        const context = $('#preview-aug-controls');
        const getVal = (selector, type = 'float') => type === 'int' ? parseInt(context.find(selector).val()) : parseFloat(context.find(selector).val());
        const isEnabled = (selector) => context.find(selector).is(':checked');
        // ... (same logic as before)
        let augOptions = {
            enabled: true,
            hflip: { enabled: isEnabled('#aug-hflip-enabled'), p: getVal('#aug-hflip-p') },
            vflip: { enabled: isEnabled('#aug-vflip-enabled'), p: getVal('#aug-vflip-p') },
            rotate90: { enabled: isEnabled('#aug-rotate90-enabled'), p: getVal('#aug-rotate90-p') },
            rotate: { enabled: isEnabled('#aug-rotate-enabled'), p: getVal('#aug-rotate-p'), limit: getVal('#aug-rotate-limit', 'int') },
            ssr: { enabled: isEnabled('#aug-ssr-enabled'), p: getVal('#aug-ssr-p'), rotate: getVal('#aug-ssr-rotate', 'int'), shift: getVal('#aug-ssr-shift'), scale: getVal('#aug-ssr-scale') },
            affine: { enabled: isEnabled('#aug-affine-enabled'), p: getVal('#aug-affine-p'), shear: getVal('#aug-affine-shear', 'int') },
            crop: { enabled: isEnabled('#aug-crop-enabled'), p: getVal('#aug-crop-p') },
            grayscale: { enabled: isEnabled('#aug-grayscale-enabled'), p: getVal('#aug-grayscale-p') },
            hsv: { enabled: isEnabled('#aug-hsv-enabled'), p: getVal('#aug-hsv-p'), h: getVal('#aug-hsv-h', 'int'), s: getVal('#aug-hsv-s', 'int'), v: getVal('#aug-hsv-v', 'int') },
            bc: { enabled: isEnabled('#aug-bc-enabled'), p: getVal('#aug-bc-p'), b: getVal('#aug-bc-b'), c: getVal('#aug-bc-c') },
            blur: { enabled: isEnabled('#aug-blur-enabled'), p: getVal('#aug-blur-p'), limit: getVal('#aug-blur-limit', 'int') },
            noise: { enabled: isEnabled('#aug-noise-enabled'), p: getVal('#aug-noise-p'), limit: getVal('#aug-noise-limit') },
            cutout: { enabled: isEnabled('#aug-cutout-enabled'), p: getVal('#aug-cutout-p'), holes: getVal('#aug-cutout-holes', 'int'), size: getVal('#aug-cutout-size', 'int') },
            mosaic: { enabled: isEnabled('#aug-mosaic-enabled'), p: getVal('#aug-mosaic-p') }
        };
        if(!isForPreview){ augOptions.multiply_factor = 3; }
        return augOptions;
    }

    let previewTimeout;
    function triggerAugmentationPreview() {
        clearTimeout(previewTimeout);
        previewTimeout = setTimeout(() => {
            const activeSource = $('#aug-preview-source-selector .active');
            if (activeSource.length > 0) {
                const videoUuid = activeSource.data('video-uuid');
                const frameNumber = activeSource.data('frame-number');
                fetchAugmentationPreviews(videoUuid, frameNumber);
            }
        }, 500);
    }

    function fetchAugmentationPreviews(videoUuid, frameNumber) {
        const gallery = $('#aug-preview-gallery');
        const loader = $('#aug-preview-loader');
        gallery.empty();
        loader.show();
        const augOptions = getAugmentationOptions(true);
        const payload = { video_uuid: videoUuid, frame_number: frameNumber, augmentation_options: augOptions, sample_pool: samplePoolData };
        $.ajax({
            url: '/api/previewAugmentations', type: 'POST', contentType: 'application/json',
            data: JSON.stringify(payload),
            success: function(response) {
                if (response.success) {
                    response.previews.forEach(imgData => { gallery.append(`<div><img src="${imgData}" alt="Augmented Preview"></div>`); });
                } else { gallery.html(`<div class="alert alert-danger w-100 rounded-0">${response.message}</div>`); }
            },
            error: function() { gallery.html('<div class="alert alert-danger w-100 rounded-0">Server error.</div>'); },
            complete: function() { loader.hide(); }
        });
    }

    // --- Chart Rendering Functions ---
    function createHistogramData(data, bins = 10, min, max) {
        if (data.length === 0) return { labels: [], counts: [] };
        min = min ?? Math.min(...data); max = max ?? Math.max(...data);
        if (min === max) { min -= 0.5; max += 0.5; }
        const binSize = (max - min) / bins;
        const counts = Array(bins).fill(0);
        const labels = [];
        for (let i = 0; i < bins; i++) {
            const binStart = min + i * binSize;
            const binEnd = binStart + binSize;
            labels.push(`${binStart.toFixed(2)}-${binEnd.toFixed(2)}`);
        }
        for (const value of data) {
            let binIndex = Math.floor((value - min) / binSize);
            binIndex = Math.max(0, Math.min(bins - 1, binIndex));
            if (value === max) binIndex = bins - 1;
            counts[binIndex]++;
        }
        return { labels, counts };
    }

    function renderSummaryAndWarnings(summary, warnings) {
        const container = $('#summary-container');
        container.empty();
        if (summary) {
            container.append(`<div class="summary-alert">${summary}</div>`);
        }
        if (warnings && warnings.length > 0) {
            const warningsList = $('<div class="list-group"></div>');
            warnings.forEach(warning => {
                warningsList.append(`<div class="warning-item"><i class="bi bi-exclamation-triangle-fill mr-2 text-warning"></i>${warning}</div>`);
            });
            container.append(warningsList);
        }
    }

    function renderCenterScatterPlot(points) {
        if(charts.centerScatter) charts.centerScatter.destroy();
        const options = getChartThemeOptions();
        $.extend(true, options.scales, {
            x: { type: 'linear', position: 'bottom', min: 0, max: 1, title: { display: true, text: 'NORM X' }},
            y: { min: 0, max: 1, reverse: true, title: { display: true, text: 'NORM Y' }}
        });
        options.plugins.legend.display = false;
        charts.centerScatter = new Chart(document.getElementById('bbox-center-scatter-plot').getContext('2d'), {
            type: 'scatter',
            data: { datasets: [{ label: 'Center', data: points, backgroundColor: getColor('scatter'), pointRadius: 2, pointHoverRadius: 4 }] },
            options: options
        });
    }

    function renderGallery(images) {
        const gallery = $('#gallery');
        gallery.empty();
        $('#gallery-count').text(images.length);
        images.forEach((image, index) => {
            const annotatedUrl = `/media/annotated_frame/${image.video_uuid}/${image.frame}.jpg`;
            const goToLabelUrl = image.task_uuid ? `/labelVideo?task_uuid=${image.task_uuid}&frame=${image.frame}` : '#';
            const buttonDisabled = image.task_uuid ? '' : 'disabled';
            const item = $(`
                <div class="gallery-item" data-index="${index}">
                    <img src="${annotatedUrl}" alt="Frame ${image.frame}" loading="lazy">
                    <div class="caption">
                        <span class="caption-text text-truncate w-100" title="${image.video}">FILE: ${image.video}</span>
                        <span class="text-muted small">SEQ: ${image.frame}</span>
                        <a href="${goToLabelUrl}" class="btn btn-sm btn-outline-primary rounded-0 mt-2 ${buttonDisabled}"><i class="bi bi-pencil-square"></i> EDIT</a>
                    </div>
                </div>`);
            item.find('img').on('click', () => window.open(image.original_url, '_blank'));
            gallery.append(item);
        });
    }

    function filterGalleryByClass(className) {
        const classImageIndices = [];
        for (const [imageIndex, classList] of Object.entries(imageClassMap)) {
            if (classList.includes(className)) { classImageIndices.push(parseInt(imageIndex)); }
        }
        $('#outlier-filter').val('none');
        $('#gallery .gallery-item').each(function() {
            const itemIndex = parseInt($(this).data('index'));
            $(this).toggleClass('hidden', !classImageIndices.includes(itemIndex));
        });
    }

    function resetGalleryFilter() {
        $('#outlier-filter').val('none');
        $('#gallery .gallery-item').removeClass('hidden');
    }

    $('#outlier-filter').on('change', function() {
        const filterType = $(this).val();
        if (filterType === 'none') { $('#gallery .gallery-item').removeClass('hidden'); return; }
        let sortedBboxes, targetImageIndices;
        switch(filterType) {
            case 'area_smallest': sortedBboxes = [...allBboxesData].sort((a, b) => a.area - b.area); break;
            case 'area_largest': sortedBboxes = [...allBboxesData].sort((a, b) => b.area - a.area); break;
            case 'ar_smallest': sortedBboxes = [...allBboxesData].sort((a, b) => Math.abs(a.aspect_ratio - 1) - Math.abs(b.aspect_ratio - 1)); break;
            case 'ar_largest': sortedBboxes = [...allBboxesData].sort((a, b) => Math.abs(b.aspect_ratio - 1) - Math.abs(a.aspect_ratio - 1)); break;
            case 'iou_high': targetImageIndices = [...new Set(suspiciousPairsData.map(p => p.image_index))]; break;
            case 'consistency_outliers': targetImageIndices = consistencyOutlierIndices; break;
        }
        if (sortedBboxes) { targetImageIndices = [...new Set(sortedBboxes.slice(0, 10).map(b => b.image_index))]; }
        $('#gallery .gallery-item').each(function() {
            const itemIndex = parseInt($(this).data('index'));
            $(this).toggleClass('hidden', !targetImageIndices.includes(itemIndex));
        });
    });

    $('#reset-filter-btn').on('click', resetGalleryFilter);

    function renderClassCounts(classCounts) {
        const chartData = { labels: Object.keys(classCounts), datasets: [{ label: 'Count', data: Object.values(classCounts), backgroundColor: getColor('primary') }]};
        if (charts.classCounts) { charts.classCounts.destroy(); }
        const options = getChartThemeOptions();
        options.onHover = (event, chartElement) => { event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default'; };
        options.onClick = (event, elements) => {
            if (elements.length > 0) {
                const clickedIndex = elements[0].index;
                const className = charts.classCounts.data.labels[clickedIndex];
                filterGalleryByClass(className);
            } else { resetGalleryFilter(); }
        };
        const ctx = document.getElementById('class-counts-chart');
        charts.classCounts = new Chart(ctx, { type: 'bar', data: chartData, options: options });
    }

    function renderObjectsPerImage(data) {
        const counts = data.reduce((acc, val) => { acc[val] = (acc[val] || 0) + 1; return acc; }, {});
        const chartData = { labels: Object.keys(counts), datasets: [{ label: 'Images', data: Object.values(counts), backgroundColor: getColor('success') }] };
        if(charts.objectsPerImage) charts.objectsPerImage.destroy();
        const options = getChartThemeOptions();
        options.scales.x.title.text = 'Obj Count';
        charts.objectsPerImage = new Chart($('#objects-per-image-chart'), { type: 'bar', data: chartData, options: options });
    }

    function renderBrightness(data) {
        const histData = createHistogramData(data, 20, 0, 255);
        const chartData = { labels: histData.labels, datasets: [{ label: 'Images', data: histData.counts, backgroundColor: getColor('warning') }] };
        if(charts.brightness) charts.brightness.destroy();
        charts.brightness = new Chart($('#brightness-chart'), { type: 'bar', data: chartData, options: getChartThemeOptions() });
    }

    function renderAspectRatio(data) {
        const logData = data.map(d => d > 0 ? Math.log10(d) : 0);
        const minLog = logData.length > 0 ? Math.min(...logData) : 0;
        const maxLog = logData.length > 0 ? Math.max(...logData) : 1;
        const histData = createHistogramData(logData, 15, minLog, maxLog);
        histData.labels = histData.labels.map(l => {
            const range = l.split('-').map(parseFloat);
            return `${Math.pow(10, range[0]).toFixed(2)}-${Math.pow(10, range[1]).toFixed(2)}`;
        });
        const chartData = { labels: histData.labels, datasets: [{ label: 'BBoxes', data: histData.counts, backgroundColor: getColor('info') }] };
        if(charts.aspectRatio) charts.aspectRatio.destroy();
        const options = getChartThemeOptions();
        options.scales.x.title.text = 'W/H Ratio';
        charts.aspectRatio = new Chart($('#aspect-ratio-chart'), { type: 'bar', data: chartData, options: options });
    }

    function renderAnnotatorStats(stats) {
        const users = Object.keys(stats);
        if (users.length === 0) { $('#annotator-chart').parent().html('<p class="text-muted text-center pt-5">NO DATA</p>'); return; }
        const imageCounts = users.map(u => stats[u].image_count);
        const chartData = { labels: users, datasets: [{ label: 'Frames', data: imageCounts, backgroundColor: getColor('danger') }] };
        if(charts.annotator) charts.annotator.destroy();
        charts.annotator = new Chart($('#annotator-chart'), { type: 'bar', data: chartData, options: getChartThemeOptions() });
    }

    // --- Main Fetch Logic ---
    $.ajax({
        url: `/api/datasetAnalysis/${datasetUuid}`, type: 'GET',
        success: function(response) {
            if (response.success) {
                $('#loading-indicator').hide();
                $('#analysis-content').fadeIn();

                originalAnalysisData = response;
                fullGalleryData = response.gallery_images;
                allBboxesData = response.all_bboxes;
                suspiciousPairsData = response.suspicious_pairs;
                imageClassMap = response.image_class_map;

                renderSummaryAndWarnings(response.summary_text, response.warnings);
                renderClassCounts(response.class_counts);
                renderObjectsPerImage(response.objects_per_image);
                renderAspectRatio(response.aspect_ratios);
                renderCenterScatterPlot(response.center_points);
                if (response.brightness_levels) renderBrightness(response.brightness_levels);
                if (response.annotator_stats) renderAnnotatorStats(response.annotator_stats);

                renderGallery(fullGalleryData);

                setupAugmentationListeners('#preview-aug-controls');
                const sourceSelector = $('#aug-preview-source-selector');
                const sampleImages = fullGalleryData.slice(0, 5);
                samplePoolData = sampleImages.map(img => ({ video_uuid: img.video_uuid, frame_number: img.frame }));

                sampleImages.forEach((img, index) => {
                    const thumb = $(`<img src="${img.original_url}" class="aug-preview-source-img" data-video-uuid="${img.video_uuid}" data-frame-number="${img.frame}">`);
                    if (index === 0) thumb.addClass('active');
                    sourceSelector.append(thumb);
                });

                if (sampleImages.length > 0) { triggerAugmentationPreview(); }
                else { $('#aug-preview-gallery-container').html('<p class="text-muted text-center pt-5 font-monospace">NO SOURCE IMAGES</p>'); }

                sourceSelector.on('click', 'img', function() {
                    sourceSelector.find('img').removeClass('active');
                    $(this).addClass('active');
                    triggerAugmentationPreview();
                });
            } else { $('#loading-indicator').html(`<div class="alert alert-danger shadow-sm">ERROR: ${response.message}</div>`); }
        },
        error: function() { $('#loading-indicator').html('<div class="alert alert-danger shadow-sm">SERVER COMMUNICATION FAILED</div>'); }
    });

    // AI Consistency Check Button
    $('#run-consistency-check-btn').on('click', function() {
        const $btn = $(this);
        $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status"></span> SCANNING...');

        const isColorCheckEnabled = $('#enable-color-check').is(':checked');

        $.ajax({
            url: `/api/datasetAnalysis/${datasetUuid}/consistency_check`,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ enable_color_check: isColorCheckEnabled }),
            success: function(response) {
                if (response.success) {
                    consistencyOutlierIndices = response.outlier_image_indices;
                    const resultMessage = $(`<div class="alert mt-3 rounded-0" style="background: rgba(0,255,148,0.1); border: 1px solid var(--color-success); color: #fff;">${response.message}</div>`);
                    $('#consistency-check-container').append(resultMessage);

                    if (consistencyOutlierIndices.length > 0) {
                        $('#outlier-filter option[value="consistency_outliers"]').show();
                        $('#outlier-filter').val('consistency_outliers').trigger('change');
                        resultMessage.append(' <br><strong>FILTER APPLIED.</strong>');
                    }
                    $btn.hide();
                } else {
                    alert('Scan Failed: ' + response.message);
                    $btn.prop('disabled', false).html('<i class="bi bi-search mr-1"></i> Initiate Scan');
                }
            },
            error: function(xhr) {
                alert("Server error.");
                $btn.prop('disabled', false).html('<i class="bi bi-search mr-1"></i> Initiate Scan');
            }
        });
    });
});
</script>
{% endblock %}
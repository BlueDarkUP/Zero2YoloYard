<!-- START OF FILE root.html -->
{% extends "layout.html" %}
{% from "_macros.html" import render_modal %}

{% block content %}
<div class="container-fluid content-wrapper fade-in">
    <!-- 主卡片容器 -->
    <div class="card shadow-sm" style="min-height: 85vh; border: none;">
        <!-- FIX: Replaced 'border-bottom' with 'border-0' to remove the double line -->
        <div class="card-header bg-transparent border-0 pt-4 pb-0 px-4">
            <ul class="nav nav-tabs card-header-tabs" id="mainTabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="videos-tab" data-toggle="tab" href="#videos" role="tab">
                        <i class="bi bi-camera-video mr-2"></i>Videos
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="datasets-tab" data-toggle="tab" href="#datasets" role="tab">
                        <i class="bi bi-database mr-2"></i>Datasets
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="models-tab" data-toggle="tab" href="#models" role="tab">
                        <i class="bi bi-box mr-2"></i>Models
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="settings-tab" data-toggle="tab" href="#settings" role="tab">
                        <i class="bi bi-gear mr-2"></i>Settings
                    </a>
                </li>
            </ul>
        </div>

        <div class="card-body p-4">
            <div class="tab-content">

                <!-- ==================== VIDEOS TAB ==================== -->
                <div class="tab-pane fade show active" id="videos" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h4 class="mb-1 font-weight-bold">Video Management</h4>
                            <p class="text-muted small mb-0">Upload raw footage, extract frames, and assign labeling tasks.</p>
                        </div>
                        <button class="btn btn-primary shadow-sm" data-toggle="modal" data-target="#uploadVideoModal">
                            <i class="bi bi-cloud-upload"></i> Upload Video
                        </button>
                    </div>

                    <!-- 隐藏的文件输入框，用于导入帧 -->
                    <input type="file" id="frame-import-input" webkitdirectory directory multiple style="display: none;" />

                    <div class="table-responsive rounded border">
                        <table class="table table-hover mb-0">
                            <thead class="bg-light">
                                <tr>
                                    <th style="width: 25%">Description</th>
                                    <th>Filename</th>
                                    <th>Status</th>
                                    <th>Progress (Extracted / Total)</th>
                                    <th>Labeled Frames</th>
                                    <th class="text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="video-list">
                                <!-- JS Populated -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- ==================== DATASETS TAB ==================== -->
                <div class="tab-pane fade" id="datasets" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h4 class="mb-1 font-weight-bold">Dataset Hub</h4>
                            <p class="text-muted small mb-0">Compile labeled data into training sets (YOLO format) with augmentation.</p>
                        </div>
                        <button class="btn btn-primary shadow-sm" data-toggle="modal" data-target="#createDatasetModal">
                            <i class="bi bi-plus-lg"></i> Create Dataset
                        </button>
                    </div>
                    <div class="table-responsive rounded border">
                        <table class="table table-hover mb-0">
                            <thead class="bg-light">
                                <tr>
                                    <th style="width: 25%">Description</th>
                                    <th>Status</th>
                                    <th>Composition</th>
                                    <th>Classes</th>
                                    <th class="text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="dataset-list">
                                <!-- JS Populated -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- ==================== MODELS TAB ==================== -->
                <div class="tab-pane fade" id="models" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h4 class="mb-1 font-weight-bold">Model Repository</h4>
                            <p class="text-muted small mb-0">Manage TFLite models used for auto-annotation assistance.</p>
                        </div>
                        <button class="btn btn-primary shadow-sm" data-toggle="modal" data-target="#importModelModal">
                            <i class="bi bi-box-arrow-in-down"></i> Import Model
                        </button>
                    </div>
                    <div class="table-responsive rounded border">
                        <table class="table table-hover mb-0">
                            <thead class="bg-light">
                                <tr>
                                    <th>Description</th>
                                    <th>Type</th>
                                    <th>Label Map</th>
                                    <th>Imported Date</th>
                                    <th class="text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="model-list">
                                <!-- JS Populated -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- ==================== SETTINGS TAB ==================== -->
                <div class="tab-pane fade" id="settings" role="tabpanel">
                    <div class="row justify-content-center">
                        <div class="col-lg-11 col-xl-10">
                            <div class="d-flex align-items-center mb-4 pb-2 border-bottom">
                                <h4 class="mb-0 font-weight-bold">System Configuration</h4>
                            </div>
                            <p class="text-muted mb-4"><i class="bi bi-info-circle"></i> Changes to AI models will apply to the next task started.</p>

                            <form id="settings-form">
                                <div class="row">
                                    <!-- Left Column: Hardware & Models -->
                                    <div class="col-lg-6">
                                        <div class="card mb-4 border shadow-sm">
                                            <div class="card-header">
                                                <h6 class="mb-0 text-primary font-weight-bold"><i class="bi bi-cpu mr-2"></i>AI Engine & Hardware</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="form-group">
                                                    <label for="setting-gpu-device" class="small text-uppercase text-muted font-weight-bold">Computation Device</label>
                                                    <select id="setting-gpu-device" class="form-control custom-select">
                                                        <option value="auto">Auto-detect (Recommended)</option>
                                                        <option value="cpu">CPU Only</option>
                                                        <option value="cuda:0">NVIDIA GPU #0 (cuda:0)</option>
                                                        <option value="cuda:1">NVIDIA GPU #1 (cuda:1)</option>
                                                    </select>
                                                </div>
                                                <div class="form-group">
                                                    <label for="setting-sam-model" class="small text-uppercase text-muted font-weight-bold">SAM Model (Assistance)</label>
                                                    <select id="setting-sam-model" class="form-control custom-select">
                                                        <option value="sam2.1_t.pt" data-name="SAM 2.1 Tiny">SAM 2.1 Tiny (Fastest)</option>
                                                        <option value="sam2.1_s.pt" data-name="SAM 2.1 Small">SAM 2.1 Small (Balanced)</option>
                                                        <option value="sam2.1_b.pt" data-name="SAM 2.1 Base">SAM 2.1 Base</option>
                                                        <option value="sam2.1_l.pt" data-name="SAM 2.1 Large">SAM 2.1 Large (Best Quality)</option>
                                                    </select>
                                                </div>
                                                <div class="form-group mb-0">
                                                    <label for="setting-feature-extractor-model" class="small text-uppercase text-muted font-weight-bold">Feature Extractor</label>
                                                    <select id="setting-feature-extractor-model" class="form-control custom-select">
                                                        <option value="mobilenet_v3_large">MobileNetV3-Large (Accurate)</option>
                                                        <option value="mobilenet_v3_small">MobileNetV3-Small (Fast)</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="card mb-4 border shadow-sm">
                                            <div class="card-header">
                                                <h6 class="mb-0 text-primary font-weight-bold"><i class="bi bi-sliders mr-2"></i>Algorithm Tuning</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="form-group">
                                                    <label class="d-flex justify-content-between small text-muted font-weight-bold">
                                                        <span>SAM Mask Confidence</span>
                                                        <span id="sam-mask-conf-val" class="text-primary">0.35</span>
                                                    </label>
                                                    <input type="range" class="custom-range" id="setting-sam-mask-confidence" min="0.1" max="0.9" step="0.05" value="0.35">
                                                </div>
                                                <div class="form-group">
                                                    <label class="d-flex justify-content-between small text-muted font-weight-bold">
                                                        <span>NMS IoU Threshold</span>
                                                        <span id="nms-iou-val" class="text-primary">0.70</span>
                                                    </label>
                                                    <input type="range" class="custom-range" id="setting-nms-iou-threshold" min="0.1" max="1.0" step="0.05" value="0.70">
                                                </div>
                                                <div class="form-group">
                                                    <label class="d-flex justify-content-between small text-muted font-weight-bold">
                                                        <span>Prototype Temperature</span>
                                                        <span id="prototype-temp-val" class="text-primary">0.07</span>
                                                    </label>
                                                    <input type="range" class="custom-range" id="setting-prototype-temperature" min="0.01" max="0.5" step="0.01" value="0.07">
                                                </div>
                                                <div class="form-group mb-0">
                                                    <label class="small text-muted font-weight-bold">Prototype Sample Limit</label>
                                                    <input type="number" class="form-control" id="setting-prototype-sample-limit" value="50" min="10" max="500">
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Right Column: Workflow & Colors -->
                                    <div class="col-lg-6">
                                        <div class="card mb-4 border shadow-sm">
                                            <div class="card-header">
                                                <h6 class="mb-0 text-primary font-weight-bold"><i class="bi bi-gear mr-2"></i>Workflow Preferences</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="form-group">
                                                    <label for="setting-default-annotation-mode" class="small text-uppercase text-muted font-weight-bold">Default Tool</label>
                                                    <select id="setting-default-annotation-mode" class="form-control custom-select">
                                                        <option value="manual">Manual Draw</option>
                                                        <option value="sam">SAM (Point)</option>
                                                        <option value="lam">LAM (Click to Label)</option>
                                                        <option value="smart_select">Smart Select</option>
                                                    </select>
                                                </div>
                                                <div class="form-group">
                                                    <div class="custom-control custom-switch">
                                                        <input type="checkbox" class="custom-control-input" id="setting-autosave-enabled">
                                                        <label class="custom-control-label font-weight-bold" for="setting-autosave-enabled">Enable Autosave on Navigation</label>
                                                    </div>
                                                </div>
                                                <hr>
                                                <div class="form-row">
                                                    <div class="form-group col-md-6">
                                                        <label class="small text-muted font-weight-bold">Default Pre-annotation Conf</label>
                                                        <input type="number" class="form-control" id="setting-preannotation-conf" min="0.1" max="0.95" step="0.05" value="0.5">
                                                    </div>
                                                    <div class="form-group col-md-6">
                                                        <label class="small text-muted font-weight-bold">Frame JPEG Quality</label>
                                                        <input type="number" id="setting-jpeg-quality" class="form-control" min="10" max="100" step="5">
                                                    </div>
                                                </div>
                                                 <div class="form-group mb-0">
                                                    <label for="setting-opencv-tracker" class="small text-muted font-weight-bold">Legacy Tracker</label>
                                                    <select id="setting-opencv-tracker" class="form-control custom-select">
                                                        {% for tracker in tracker_fns %}<option value="{{ tracker }}">{{ tracker }}</option>{% endfor %}
                                                    </select>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="card mb-4 border shadow-sm">
                                            <div class="card-header">
                                                <h6 class="mb-0 text-primary font-weight-bold"><i class="bi bi-palette mr-2"></i>Class Colors</h6>
                                            </div>
                                            <div class="card-body">
                                                <p class="text-muted small mb-2">Customize colors for labels. Unset classes use auto-generated colors.</p>
                                                <div id="class-color-manager" style="max-height: 250px; overflow-y: auto; padding-right: 5px;" class="custom-scrollbar">
                                                    <!-- JS Populated -->
                                                </div>
                                            </div>
                                        </div>

                                        <div class="card mb-4 border shadow-sm border-warning">
                                            <div class="card-header bg-warning-soft">
                                                <h6 class="mb-0 text-warning font-weight-bold"><i class="bi bi-trash mr-2"></i>Cache & Maintenance</h6>
                                            </div>
                                            <div class="card-body">
                                                 <div class="form-group">
                                                    <label class="small text-muted font-weight-bold">Cache Save Interval (s)</label>
                                                    <input type="number" class="form-control" id="setting-cache-save-interval" value="30" min="10" max="300">
                                                </div>
                                                <button type="button" class="btn btn-outline-warning btn-block" id="clear-cache-btn">
                                                    <i class="bi bi-eraser-fill"></i> Clear Feature Cache
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Batch Tracking Settings (Full Width) -->
                                    <div class="col-12">
                                        <div class="card mb-4 border shadow-sm">
                                             <div class="card-header">
                                                <h6 class="mb-0 text-primary font-weight-bold"><i class="bi bi-film mr-2"></i>Batch Tracking Defaults</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="form-row">
                                                    <div class="form-group col-md-4">
                                                        <label class="small text-muted font-weight-bold">Image Size</label>
                                                        <input type="number" class="form-control" id="setting-batch-tracking-imgsz" value="1024" min="256" step="128">
                                                    </div>
                                                    <div class="form-group col-md-4">
                                                        <label class="d-flex justify-content-between small text-muted font-weight-bold">
                                                            <span>Confidence</span>
                                                            <span id="batch-track-conf-val" class="text-primary">0.30</span>
                                                        </label>
                                                        <input type="range" class="custom-range" id="setting-batch-tracking-conf" min="0.1" max="0.9" step="0.05" value="0.30">
                                                    </div>
                                                    <div class="form-group col-md-4">
                                                        <label class="small text-muted font-weight-bold">Chunk Size</label>
                                                        <input type="number" class="form-control" id="setting-batch-tracking-chunk-size" value="10" min="5" max="50">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="fixed-bottom p-3 bg-white border-top shadow-lg d-flex justify-content-end" style="z-index: 1000; left: 0;">
                                    <button type="submit" class="btn btn-primary px-4 shadow">
                                        <i class="bi bi-check2-circle"></i> Apply & Save All Settings
                                    </button>
                                </div>
                                <!-- Add padding to prevent button from overlapping content -->
                                <div style="height: 60px;"></div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ==================== MODALS ==================== -->
{% call render_modal('uploadVideoModal', 'Upload New Video') %}
<form id="upload-video-form">
    <div class="form-group">
        <label for="video-description" class="font-weight-bold">Description</label>
        <input type="text" class="form-control" id="video-description" name="description" placeholder="E.g., Field Test Match 1" required maxlength="{{ limit_data.MAX_DESCRIPTION_LENGTH }}">
    </div>
    <div class="form-group">
        <label for="video-file" class="font-weight-bold">Video File (.mp4)</label>
        <div class="custom-file">
            <input type="file" class="custom-file-input" id="video-file" name="video_file" accept="video/mp4" required>
            <label class="custom-file-label" for="video-file">Choose file...</label>
        </div>
        <small class="form-text text-muted">Max size: {{ limit_data.MAX_VIDEO_SIZE_MB }}MB.</small>
    </div>
    <button type="submit" class="btn btn-primary btn-block shadow-sm"><i class="bi bi-upload"></i> Upload & Process</button>
</form>
{% endcall %}

{% call render_modal('createDatasetModal', 'Create Dataset') %}
<form id="create-dataset-form">
    <div class="form-group">
        <label for="dataset-description" class="font-weight-bold">Name / Description</label>
        <input type="text" class="form-control" id="dataset-description" placeholder="E.g., Season 2024 V1" required maxlength="{{ limit_data.MAX_DESCRIPTION_LENGTH }}">
    </div>
    <div class="form-group">
        <label for="dataset-videos" class="font-weight-bold">Select Source Videos</label>
        <select multiple class="form-control custom-select" id="dataset-videos" required size="6"></select>
        <small class="form-text text-muted"><i class="bi bi-info-circle"></i> Hold Ctrl/Cmd to select multiple videos.</small>
    </div>
    <div class="form-row">
        <div class="form-group col-md-6">
            <label for="eval-percent" class="font-weight-bold">Validation %</label>
            <input type="number" class="form-control" id="eval-percent" value="20" min="5" max="50" step="1">
        </div>
        <div class="form-group col-md-6">
            <label for="test-percent" class="font-weight-bold">Test %</label>
            <input type="number" class="form-control" id="test-percent" value="10" min="0" max="50" step="1">
        </div>
    </div>

    <div class="card bg-light border-0 mb-3">
        <div class="card-body p-3">
            <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0 font-weight-bold"><i class="bi bi-magic mr-1"></i> Data Augmentation</h6>
                <div class="custom-control custom-switch">
                    <input type="checkbox" class="custom-control-input" id="aug-enabled">
                    <label class="custom-control-label font-weight-bold" for="aug-enabled">Enable</label>
                </div>
            </div>
            <div id="augmentation-options-panel" class="mt-3" style="display: none;">
                <div class="form-group">
                    <label for="aug-multiply-factor" class="small text-muted font-weight-bold">Multiplication Factor</label>
                    <input type="number" class="form-control" id="aug-multiply-factor" value="3" min="2" max="20">
                    <small class="form-text text-muted">Generate N-1 augmented copies per image.</small>
                </div>
                <!-- Include the shared augmentation controls partial -->
                {% include '_augmentation_controls.html' %}
            </div>
        </div>
    </div>
    <button type="submit" class="btn btn-primary btn-block shadow-sm"><i class="bi bi-check-lg"></i> Create Dataset</button>
</form>
{% endcall %}

{% call render_modal('importModelModal', 'Import TFLite Model') %}
<form id="import-model-form">
    <div class="form-group">
        <label for="model-description" class="font-weight-bold">Description</label>
        <input type="text" class="form-control" id="model-description" name="description" placeholder="E.g., CenterStage v1" required maxlength="{{ limit_data.MAX_DESCRIPTION_LENGTH }}">
    </div>
    <div class="form-group">
        <label for="model-file" class="font-weight-bold">Model File (.tflite)</label>
        <div class="custom-file">
            <input type="file" class="custom-file-input" id="model-file" name="model_file" accept=".tflite" required>
            <label class="custom-file-label" for="model-file">Choose file...</label>
        </div>
    </div>
    <div class="form-group">
        <label for="label-file" class="font-weight-bold">Label Map (.txt)</label>
        <div class="custom-file">
            <input type="file" class="custom-file-input" id="label-file" name="label_file" accept=".txt,.labels" required>
            <label class="custom-file-label" for="label-file">Choose file...</label>
        </div>
    </div>
    <div class="form-group">
        <label for="model-type" class="font-weight-bold">Quantization Type</label>
        <select class="form-control custom-select" id="model-type" name="model_type" required>
            <option value="" disabled selected>-- Select Type --</option>
            <option value="float32">Float32 (FP32) - Standard</option>
            <option value="uint8">Integer (UINT8) - Edge TPU Compatible</option>
        </select>
    </div>
    <button type="submit" class="btn btn-primary btn-block shadow-sm"><i class="bi bi-box-arrow-in-down"></i> Import Model</button>
</form>
{% endcall %}

{% call render_modal('preAnnotateModal', 'Auto-Label Video') %}
<form id="pre-annotate-form">
    <input type="hidden" id="pre-annotate-video-uuid" data-frame-count="0" data-labeled-count="0">
    <div class="form-group">
        <label for="pre-annotate-model-select" class="font-weight-bold">Select AI Model</label>
        <select id="pre-annotate-model-select" class="form-control custom-select" required></select>
    </div>
    <div class="form-row">
        <div class="form-group col-md-6">
            <label for="pre-annotate-start-frame" class="font-weight-bold">Start Frame</label>
            <input type="number" id="pre-annotate-start-frame" class="form-control" min="0" value="0">
        </div>
        <div class="form-group col-md-6">
            <label for="pre-annotate-end-frame" class="font-weight-bold">End Frame</label>
            <input type="number" id="pre-annotate-end-frame" class="form-control" min="0">
        </div>
    </div>
    <div class="form-group">
        <label class="d-flex justify-content-between font-weight-bold">
            <span>Confidence Threshold</span>
            <span id="confidence-value" class="text-primary">0.5</span>
        </label>
        <input type="range" class="custom-range" id="pre-annotate-confidence" min="0.1" max="0.95" step="0.05" value="0.5">
    </div>
    <div class="form-group bg-light p-3 rounded border">
        <label class="font-weight-bold mb-2">Merge Strategy</label>
        <div class="custom-control custom-radio mb-1">
            <input type="radio" id="strategy-overwrite" name="merge_strategy" value="overwrite" class="custom-control-input" checked>
            <label class="custom-control-label" for="strategy-overwrite">Overwrite existing labels</label>
        </div>
        <div class="custom-control custom-radio">
            <input type="radio" id="strategy-skip" name="merge_strategy" value="skip_labeled" class="custom-control-input">
            <label class="custom-control-label" for="strategy-skip">Skip labeled frames (Fill gaps)</label>
        </div>
    </div>
    <button type="submit" class="btn btn-primary btn-block shadow-sm"><i class="bi bi-robot"></i> Start Auto-Labeling</button>
</form>
{% endcall %}

<div class="modal fade" id="manageTasksModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title font-weight-bold" id="manageTasksModalTitle">Manage Tasks</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            </div>
            <div class="modal-body">
                <h6 class="font-weight-bold text-primary mb-3"><i class="bi bi-list-task mr-1"></i> Current Tasks</h6>
                <div class="table-responsive mb-4 rounded border">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th>Assignee</th>
                                <th>Range</th>
                                <th>Note</th>
                                <th class="text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="task-list-in-modal"></tbody>
                    </table>
                </div>

                <h6 class="font-weight-bold text-success mb-3"><i class="bi bi-plus-circle-dotted mr-1"></i> Assign New Task</h6>
                <form id="create-task-form" class="bg-light p-3 rounded border">
                    <input type="hidden" id="task-video-uuid">
                    <div class="form-row">
                        <div class="form-group col-md-4">
                            <label for="task-assigned-to" class="small font-weight-bold">User</label>
                            <input type="text" class="form-control form-control-sm" id="task-assigned-to" placeholder="Name" required>
                        </div>
                        <div class="form-group col-md-3">
                            <label for="task-start-frame" class="small font-weight-bold">Start</label>
                            <input type="number" class="form-control form-control-sm" id="task-start-frame" min="0" required>
                        </div>
                        <div class="form-group col-md-3">
                            <label for="task-end-frame" class="small font-weight-bold">End</label>
                            <input type="number" class="form-control form-control-sm" id="task-end-frame" min="0" required>
                        </div>
                        <div class="form-group col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-sm btn-success btn-block">Assign</button>
                        </div>
                    </div>
                    <div class="form-group mb-0">
                        <label for="task-description" class="small font-weight-bold">Instructions (Optional)</label>
                        <input type="text" class="form-control form-control-sm" id="task-description" placeholder="E.g., Label Red Ducks only">
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        let currentSettings = {};

        // File input label update
        $('.custom-file-input').on('change', function() {
            let fileName = $(this).val().split('\\').pop();
            $(this).next('.custom-file-label').addClass("selected").html(fileName);
        });

        // Helper to create nice badges (CSS Class Updated for Dark Mode)
        function getStatusBadge(status, message) {
            let badgeClass = 'secondary';
            let icon = '';

            if (status === 'READY') {
                badgeClass = message ? 'warning' : 'success';
                icon = '<i class="bi bi-check-circle-fill mr-1"></i>';
            } else if (['PROCESSING', 'EXTRACTING', 'PENDING', 'PRE_ANNOTATING', 'APPLYING_PROTOTYPES'].includes(status)) {
                badgeClass = 'info';
                icon = '<span class="spinner-border spinner-border-sm mr-1"></span>';
            } else if (status === 'CANCELLING') {
                badgeClass = 'warning';
                icon = '<i class="bi bi-x-circle mr-1"></i>';
            } else if (status === 'FAILED') {
                badgeClass = 'danger';
                icon = '<i class="bi bi-exclamation-triangle-fill mr-1"></i>';
            }

            return `<span class="badge badge-${badgeClass} d-inline-flex align-items-center">${icon} ${status}</span>`;
        }

        function showSuccess(message) { alert(message); }
        function showError(message) { alert('Error: ' + message); }

        // --- Video Management ---
        function refreshVideos() {
            $.get('/listVideos', function(data) {
                const videoList = $('#video-list');
                videoList.empty();
                data.all_videos.forEach(video => {
                    const isReady = video.status === 'READY';

                    let actions = '';
                    if (isReady) {
                        actions += `<button class="btn btn-sm btn-info btn-import-frames mr-1" data-uuid="${video.video_uuid}" title="Import frames"><i class="bi bi-images"></i></button>`;
                        actions += `<button class="btn btn-sm btn-warning btn-pre-annotate mr-1" data-uuid="${video.video_uuid}" data-frame-count="${video.frame_count}" data-labeled-count="${video.labeled_frame_count}" title="Auto-Label"><i class="bi bi-robot"></i></button>`;
                        actions += `<button class="btn btn-sm btn-success btn-manage-tasks mr-1" data-uuid="${video.video_uuid}" data-description="${video.description}" data-framecount="${video.frame_count}" title="Tasks"><i class="bi bi-card-checklist"></i></button>`;
                    } else {
                         actions += `<button class="btn btn-sm btn-secondary mr-1" disabled><i class="bi bi-images"></i></button>`;
                    }

                    if (['PRE_ANNOTATING', 'APPLYING_PROTOTYPES'].includes(video.status)) {
                        actions += `<button class="btn btn-sm btn-danger btn-cancel-task mr-1" data-uuid="${video.video_uuid}" title="Cancel Task"><i class="bi bi-stop-circle"></i></button>`;
                    }

                    actions += `<button class="btn btn-sm btn-outline-danger btn-delete-video" data-uuid="${video.video_uuid}" title="Delete"><i class="bi bi-trash"></i></button>`;

                    const progress = video.extracted_frame_count ? `${video.extracted_frame_count} / ${video.frame_count || '?'}` : '-';
                    const statusHtml = getStatusBadge(video.status, video.status_message);
                    const statusMsg = video.status_message ? `<div class="small text-muted mt-1">${video.status_message}</div>` : '';

                    const row = `
                        <tr>
                            <td class="align-middle"><strong>${video.description}</strong></td>
                            <td class="align-middle text-muted small">${video.video_filename || ''}</td>
                            <td class="align-middle">${statusHtml}${statusMsg}</td>
                            <td class="align-middle font-weight-bold text-muted small">${progress}</td>
                            <td class="align-middle"><span class="badge badge-neutral">${video.labeled_frame_count}</span></td>
                            <td class="align-middle text-right">${actions}</td>
                        </tr>`;
                    videoList.append(row);
                });

                // Update select for Dataset creation
                const datasetVideoSelect = $('#dataset-videos');
                datasetVideoSelect.empty();
                data.ready_videos_for_dataset.forEach(video => {
                    datasetVideoSelect.append(`<option value="${video.video_uuid}">${video.description} (${video.labeled_frame_count} labels)</option>`);
                });
            });
        }

        // --- Dataset Management ---
        function refreshDatasets() {
            $.get('/listDatasets', function(data) {
                const datasetList = $('#dataset-list');
                datasetList.empty();
                data.datasets.forEach(dataset => {
                    let actions = '';
                    if (dataset.status === 'READY') {
                        actions += `<a href="/downloadDataset/${dataset.dataset_uuid}" class="btn btn-sm btn-success mr-1" title="Download"><i class="bi bi-download"></i></a>`;
                        actions += `<a href="/datasetAnalysis/${dataset.dataset_uuid}" class="btn btn-sm btn-info mr-1" title="Analyze"><i class="bi bi-bar-chart-line"></i></a>`;
                        actions += `<button class="btn btn-sm btn-secondary btn-regenerate-dataset mr-1" data-uuid="${dataset.dataset_uuid}" title="Update"><i class="bi bi-arrow-repeat"></i></button>`;
                    } else if (dataset.status === 'FAILED') {
                         actions += `<button class="btn btn-sm btn-warning btn-regenerate-dataset mr-1" data-uuid="${dataset.dataset_uuid}" title="Retry"><i class="bi bi-arrow-repeat"></i></button>`;
                    }
                    actions += `<button class="btn btn-sm btn-outline-danger btn-delete-dataset" data-uuid="${dataset.dataset_uuid}" title="Delete"><i class="bi bi-trash"></i></button>`;

                    const videosCount = JSON.parse(dataset.video_uuids || '[]').length;

                    const classes = JSON.parse(dataset.sorted_label_list || '[]')
                        .map(c => `<span class="badge badge-neutral badge-pill mr-1 mb-1">${c}</span>`).join('');

                    const row = `
                        <tr>
                            <td class="align-middle"><strong>${dataset.description}</strong></td>
                            <td class="align-middle">${getStatusBadge(dataset.status, dataset.status_message)}</td>
                            <td class="align-middle">${videosCount} video(s)</td>
                            <td class="align-middle" style="line-height: 1.8;">${classes || '<span class="text-muted">-</span>'}</td>
                            <td class="align-middle text-right">${actions}</td>
                        </tr>`;
                    datasetList.append(row);
                });
            });
        }

        // --- Model Management ---
        function refreshModels() {
            $.get('/listModels', function(data) {
                const modelList = $('#model-list');
                modelList.empty();
                data.models.forEach(model => {
                    const createdDate = new Date(model.create_time_ms).toLocaleDateString();
                    const typeBadge = model.model_type === 'uint8'
                        ? `<span class="badge badge-info">INT8 (TPU)</span>`
                        : `<span class="badge badge-primary">FP32</span>`;

                    const row = `
                        <tr>
                            <td class="align-middle"><strong>${model.description}</strong></td>
                            <td class="align-middle">${typeBadge}</td>
                            <td class="align-middle text-muted small">${model.label_filename || 'N/A'}</td>
                            <td class="align-middle text-muted small">${createdDate}</td>
                            <td class="align-middle text-right">
                                <button class="btn btn-sm btn-outline-danger btn-delete-model" data-uuid="${model.model_uuid}"><i class="bi bi-trash"></i></button>
                            </td>
                        </tr>`;
                    modelList.append(row);
                });
            });
        }

        // --- Settings ---
        function loadSettings() {
            $.get('/api/settings', function(data) {
                if (data.success) {
                    currentSettings = data.settings;
                    const s = data.settings;

                    // Fill form values
                    $('#setting-gpu-device').val(s.gpu_device);
                    $('#setting-sam-model').val(s.sam_model_checkpoint);
                    $('#setting-feature-extractor-model').val(s.feature_extractor_model_name);
                    $('#setting-sam-mask-confidence').val(s.sam_mask_confidence).trigger('input');
                    $('#setting-nms-iou-threshold').val(s.nms_iou_threshold).trigger('input');
                    $('#setting-prototype-temperature').val(s.prototype_temperature).trigger('input');
                    $('#setting-prototype-sample-limit').val(s.prototype_sample_limit);
                    $('#setting-batch-tracking-imgsz').val(s.batch_tracking_imgsz);
                    $('#setting-batch-tracking-conf').val(s.batch_tracking_conf).trigger('input');
                    $('#setting-batch-tracking-chunk-size').val(s.batch_tracking_chunk_size);
                    $('#setting-default-annotation-mode').val(s.default_annotation_mode);
                    $('#setting-autosave-enabled').prop('checked', s.autosave_enabled);
                    $('#setting-preannotation-conf').val(s.default_preannotation_conf).trigger('input');
                    $('#setting-jpeg-quality').val(s.frame_extraction_jpeg_quality);
                    $('#setting-opencv-tracker').val(s.default_opencv_tracker);
                    $('#setting-cache-save-interval').val(s.cache_save_interval_seconds);

                    loadClassColorManager();
                }
            });
        }

        function loadClassColorManager() {
            $.get('/listClasses', function(data) {
                if (data.success) {
                    const container = $('#class-color-manager');
                    container.empty();
                    if (data.labels.length === 0) {
                        container.html('<p class="text-muted small pl-2">No classes found. Add classes in the annotation view first.</p>');
                        return;
                    }
                    const classColors = currentSettings.class_colors || {};
                    data.labels.forEach(label => {
                        const color = classColors[label] || '#000000';
                        const item = `
                        <div class="d-flex align-items-center bg-white border rounded px-2 py-1 mr-2 mb-2 shadow-sm" style="min-width: 120px;">
                            <input type="color" class="border-0 p-0 mr-2 rounded-circle" value="${color}" data-class-name="${label}"
                                   style="width: 24px; height: 24px; cursor: pointer; background: none;" title="Change color for ${label}">
                            <span class="small font-weight-bold text-truncate" style="max-width: 100px;">${label}</span>
                        </div>`;
                        container.append(item);
                    });
                }
            });
        }

        // --- Augmentation Controls Logic ---
        function setupAugmentationListeners(contextSelector) {
            const context = $(contextSelector);
            context.on('input', 'input[type="range"]', function() {
                $(this).closest('div').find('.val-display').text($(this).val());
            });
            context.on('change', '.aug-option input[type="checkbox"]', function() {
                const controlsId = $(this).closest('.aug-option').data('controls');
                context.find('#' + controlsId).toggle($(this).is(':checked'));
            });
            // Init state
            context.find('.aug-option input[type="checkbox"]').each(function() {
                const controlsId = $(this).closest('.aug-option').data('controls');
                context.find('#' + controlsId).toggle($(this).is(':checked'));
            });
        }
        $('#aug-enabled').on('change', function() {
            $('#augmentation-options-panel').slideToggle($(this).is(':checked'));
        });
        setupAugmentationListeners('#createDatasetModal'); // Initialize inside modal

        // --- Helper to extract augmentation data ---
        function getAugmentationOptions(contextSelector) {
            const context = $(contextSelector);
            const getVal = (selector, type = 'float') => type === 'int' ? parseInt(context.find(selector).val()) : parseFloat(context.find(selector).val());
            const isEnabled = (selector) => context.find(selector).is(':checked');
            return {
                enabled: isEnabled('#aug-enabled'),
                multiply_factor: getVal('#aug-multiply-factor', 'int'),
                hflip: { enabled: isEnabled('#aug-hflip-enabled'), p: getVal('#aug-hflip-p') },
                vflip: { enabled: isEnabled('#aug-vflip-enabled'), p: getVal('#aug-vflip-p') },
                rotate90: { enabled: isEnabled('#aug-rotate90-enabled'), p: getVal('#aug-rotate90-p') },
                rotate: { enabled: isEnabled('#aug-rotate-enabled'), p: getVal('#aug-rotate-p'), limit: getVal('#aug-rotate-limit', 'int') },
                ssr: { enabled: isEnabled('#aug-ssr-enabled'), p: getVal('#aug-ssr-p'), rotate: getVal('#aug-ssr-rotate', 'int'), shift: getVal('#aug-ssr-shift'), scale: getVal('#aug-ssr-scale') },
                affine: { enabled: isEnabled('#aug-affine-enabled'), p: getVal('#aug-affine-p'), shear: getVal('#aug-affine-shear', 'int') },
                crop: { enabled: isEnabled('#aug-crop-enabled'), p: getVal('#aug-crop-p') },
                grayscale: { enabled: isEnabled('#aug-grayscale-enabled'), p: getVal('#aug-grayscale-p') },
                hsv: { enabled: isEnabled('#aug-hsv-enabled'), p: getVal('#aug-hsv-p'), h: getVal('#aug-hsv-h', 'int'), s: getVal('#aug-hsv-s', 'int'), v: getVal('#aug-hsv-v', 'int') },
                bc: { enabled: isEnabled('#aug-bc-enabled'), p: getVal('#aug-bc-p'), b: getVal('#aug-bc-b'), c: getVal('#aug-bc-c') },
                blur: { enabled: isEnabled('#aug-blur-enabled'), p: getVal('#aug-blur-p'), limit: getVal('#aug-blur-limit', 'int') },
                noise: { enabled: isEnabled('#aug-noise-enabled'), p: getVal('#aug-noise-p'), limit: getVal('#aug-noise-limit') },
                cutout: { enabled: isEnabled('#aug-cutout-enabled'), p: getVal('#aug-cutout-p'), holes: getVal('#aug-cutout-holes', 'int'), size: getVal('#aug-cutout-size', 'int') },
                mosaic: { enabled: isEnabled('#aug-mosaic-enabled'), p: getVal('#aug-mosaic-p') }
            };
        }

        // --- Form Submissions ---

        $('#create-dataset-form').on('submit', function(e) {
            e.preventDefault();
            const augmentation_options = getAugmentationOptions('#createDatasetModal');
            const datasetData = {
                description: $('#dataset-description').val(),
                video_uuids: $('#dataset-videos').val(),
                eval_percent: $('#eval-percent').val(),
                test_percent: $('#test-percent').val(),
                augmentation_options: augmentation_options
            };
            $.ajax({
                url: '/createDataset', type: 'POST', contentType: 'application/json',
                data: JSON.stringify(datasetData),
                success: function(response) {
                    if (response.success) {
                        showSuccess('Dataset creation started!');
                        $('#createDatasetModal').modal('hide');
                        refreshDatasets();
                    } else { showError(response.message); }
                },
                error: function(xhr) { showError(xhr.responseJSON ? xhr.responseJSON.message : 'Unknown error.'); }
            });
        });

        $('#upload-video-form').on('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            $.ajax({
                url: '/uploadVideo', type: 'POST', data: formData, processData: false, contentType: false,
                success: function(response) {
                    if (response.success) {
                        showSuccess('Upload successful! Processing started.');
                        $('#uploadVideoModal').modal('hide');
                        $(this).trigger('reset');
                        $('.custom-file-label').html('Choose file...');
                        refreshVideos();
                    } else { showError(response.message); }
                }.bind(this),
                error: function(xhr) { showError(xhr.responseJSON ? xhr.responseJSON.message : 'Unknown error.'); }
            });
        });

        $('#import-model-form').on('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            $.ajax({
                url: '/importModel', type: 'POST', data: formData, processData: false, contentType: false,
                success: function(response) {
                    if (response.success) {
                        showSuccess('Model imported!');
                        $('#importModelModal').modal('hide');
                        $(this).trigger('reset');
                        $('.custom-file-label').html('Choose file...');
                        refreshModels();
                    } else { showError(response.message); }
                }.bind(this),
                error: function(xhr) { showError(xhr.responseJSON ? xhr.responseJSON.message : 'Unknown error.'); }
            });
        });

        // Settings Save
        $('#settings-form').on('submit', function(e) {
            e.preventDefault();
            const selectedSamOption = $('#setting-sam-model').find('option:selected');
            const classColors = {};
            $('#class-color-manager input[type="color"]').each(function() {
                classColors[$(this).data('class-name')] = $(this).val();
            });

            const settingsData = {
                gpu_device: $('#setting-gpu-device').val(),
                sam_model_checkpoint: selectedSamOption.val(),
                sam_model_name: selectedSamOption.data('name'),
                feature_extractor_model_name: $('#setting-feature-extractor-model').val(),
                sam_mask_confidence: parseFloat($('#setting-sam-mask-confidence').val()),
                nms_iou_threshold: parseFloat($('#setting-nms-iou-threshold').val()),
                prototype_temperature: parseFloat($('#setting-prototype-temperature').val()),
                prototype_sample_limit: parseInt($('#setting-prototype-sample-limit').val()),
                batch_tracking_imgsz: parseInt($('#setting-batch-tracking-imgsz').val()),
                batch_tracking_conf: parseFloat($('#setting-batch-tracking-conf').val()),
                batch_tracking_chunk_size: parseInt($('#setting-batch-tracking-chunk-size').val()),
                default_annotation_mode: $('#setting-default-annotation-mode').val(),
                autosave_enabled: $('#setting-autosave-enabled').is(':checked'),
                default_preannotation_conf: parseFloat($('#setting-preannotation-conf').val()),
                frame_extraction_jpeg_quality: parseInt($('#setting-jpeg-quality').val()),
                default_opencv_tracker: $('#setting-opencv-tracker').val(),
                cache_save_interval_seconds: parseInt($('#setting-cache-save-interval').val()),
                class_colors: classColors
            };

            $.ajax({
                url: '/api/settings', type: 'POST', contentType: 'application/json',
                data: JSON.stringify(settingsData),
                success: function(response) {
                    if (response.success) {
                         alert(response.restart_required ? "Settings saved! AI model/device changes will apply to new tasks." : "Settings saved successfully!");
                    } else { showError(response.message); }
                },
                error: function(xhr) { showError(xhr.responseJSON ? xhr.responseJSON.message : 'Unknown error.'); }
            });
        });

        // Range input value display listeners
        ['sam-mask-confidence', 'nms-iou-threshold', 'prototype-temperature', 'batch-tracking-conf', 'preannotation-conf'].forEach(id => {
            $(`#setting-${id}`).on('input', function() {
                // Find associated display span (assumes consistent naming or relative position)
                $(this).prev('label').find('span').text(parseFloat($(this).val()).toFixed(2));
            });
        });

        // Clear Cache
        $('#clear-cache-btn').on('click', function() {
            if (confirm("Clear 'Smart Select' temporary cache?")) {
                const $btn = $(this);
                $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Clearing...');
                $.ajax({
                    url: '/api/clear_cache', type: 'POST',
                    success: function(res) { alert(res.message); },
                    complete: function() { $btn.prop('disabled', false).html('<i class="bi bi-eraser-fill"></i> Clear Feature Cache'); }
                });
            }
        });

        // --- Task Management Modal Logic ---
        $(document).on("click", ".btn-manage-tasks", function() {
            const videoUuid = $(this).data("uuid");
            const videoDesc = $(this).data("description");
            const frameCount = $(this).data("framecount");

            $('#manageTasksModalTitle').text('Tasks: ' + videoDesc);
            $('#task-video-uuid').val(videoUuid);
            $('#task-start-frame').attr('max', frameCount - 1);
            $('#task-end-frame').attr('max', frameCount - 1);

            refreshTasksInModal(videoUuid);
            $('#manageTasksModal').modal('show');
        });

        function refreshTasksInModal(videoUuid) {
            const taskListBody = $('#task-list-in-modal');
            taskListBody.html('<tr><td colspan="4" class="text-center text-muted"><span class="spinner-border spinner-border-sm"></span> Loading...</td></tr>');

            $.get(`/listTasks?video_uuid=${videoUuid}`, function(data) {
                taskListBody.empty();
                if (data.success && data.tasks.length > 0) {
                    data.tasks.forEach(task => {
                        const row = `
                            <tr>
                                <td class="align-middle font-weight-bold">${task.assigned_to}</td>
                                <td class="align-middle">${task.start_frame} - ${task.end_frame}</td>
                                <td class="align-middle text-muted small">${task.description || '-'}</td>
                                <td class="align-middle text-right">
                                    <a href="/labelVideo?task_uuid=${task.task_uuid}" class="btn btn-sm btn-primary" title="Label"><i class="bi bi-pencil-square"></i></a>
                                    <button class="btn btn-sm btn-outline-danger btn-delete-task" data-task-uuid="${task.task_uuid}" data-video-uuid="${videoUuid}"><i class="bi bi-trash"></i></button>
                                </td>
                            </tr>`;
                        taskListBody.append(row);
                    });
                } else {
                    taskListBody.html('<tr><td colspan="4" class="text-center text-muted p-3">No tasks created yet.</td></tr>');
                }
            });
        }

        $('#create-task-form').on('submit', function(e) {
            e.preventDefault();
            const videoUuid = $('#task-video-uuid').val();
            const taskData = {
                video_uuid: videoUuid,
                assigned_to: $('#task-assigned-to').val(),
                description: $('#task-description').val(),
                start_frame: $('#task-start-frame').val(),
                end_frame: $('#task-end-frame').val(),
            };
            $.ajax({
                url: '/createTask', type: 'POST', contentType: 'application/json', data: JSON.stringify(taskData),
                success: function(response) {
                    if (response.success) {
                        $('#create-task-form')[0].reset();
                        refreshTasksInModal(videoUuid);
                    } else { showError(response.message); }
                },
                error: function() { showError('Error creating task.'); }
            });
        });

        // --- Pre-Annotation Logic ---
        $(document).on("click", ".btn-pre-annotate", function() {
            const videoUuid = $(this).data('uuid');
            const frameCount = parseInt($(this).data('frame-count'));
            const labeledCount = parseInt($(this).data('labeled-count'));

            $('#pre-annotate-video-uuid').val(videoUuid).data('frame-count', frameCount).data('labeled-count', labeledCount);
            const modelSelect = $('#pre-annotate-model-select');
            modelSelect.html('<option>Loading models...</option>');

            $('#pre-annotate-start-frame').val(0).attr('max', frameCount - 1);
            $('#pre-annotate-end-frame').val(frameCount - 1).attr('max', frameCount - 1);

            $.get('/listModels', function(data) {
                modelSelect.empty();
                if (data.models && data.models.length > 0) {
                    data.models.forEach(model => {
                        modelSelect.append(`<option value="${model.model_uuid}">${model.description} (${model.model_type})</option>`);
                    });
                } else {
                    modelSelect.append('<option disabled>No models available. Import one first.</option>');
                }
            });
            $('#preAnnotateModal').modal('show');
        });

        $('#pre-annotate-confidence').on('input', function() { $('#confidence-value').text($(this).val()); });

        $('#pre-annotate-form').on('submit', function(e) {
            e.preventDefault();
            const videoUuid = $('#pre-annotate-video-uuid').val();
            const modelUuid = $('#pre-annotate-model-select').val();
            const labeledCount = parseInt($('#pre-annotate-video-uuid').data('labeled-count'));

            if (!modelUuid) return showError("Please select a model.");

            let msg = "Start auto-labeling?";
            if (labeledCount > 0 && $('input[name="merge_strategy"]:checked').val() === 'overwrite') {
                msg = `WARNING: This video has ${labeledCount} labels. This will OVERWRITE them in the selected range. Continue?`;
            }
            if (!confirm(msg)) return;

            const options = {
                start_frame: $('#pre-annotate-start-frame').val(),
                end_frame: $('#pre-annotate-end-frame').val(),
                confidence: $('#pre-annotate-confidence').val(),
                merge_strategy: $('input[name="merge_strategy"]:checked').val()
            };

            $.ajax({
                url: '/startPreAnnotation', type: 'POST', contentType: 'application/json',
                data: JSON.stringify({ video_uuid: videoUuid, model_uuid: modelUuid, options: options }),
                success: function(response) {
                    if (response.success) {
                        showSuccess('Auto-labeling started.');
                        $('#preAnnotateModal').modal('hide');
                        refreshVideos();
                    } else { showError(response.message); }
                },
                error: function(xhr) { showError(xhr.responseJSON ? xhr.responseJSON.message : 'Unknown error.'); }
            });
        });

        // --- Other Actions ---
        let videoUuidForImport = null;
        $(document).on("click", ".btn-import-frames", function() {
            videoUuidForImport = $(this).data('uuid');
            $('#frame-import-input').click();
        });

        $('#frame-import-input').on('change', function(e) {
            if (!videoUuidForImport || e.target.files.length === 0) return;
            const formData = new FormData(this);
            formData.append('video_uuid', videoUuidForImport);
            for (let i = 0; i < e.target.files.length; i++) formData.append('frame_files', e.target.files[i]);

            alert(`Importing ${e.target.files.length} frames...`);
            $.ajax({
                url: '/importFrames', type: 'POST', data: formData, processData: false, contentType: false,
                success: function(res) {
                    if(res.success) { showSuccess(`Imported ${res.imported_count} frames.`); refreshVideos(); }
                    else showError(res.message);
                },
                error: function() { showError('Import failed.'); },
                complete: function() { videoUuidForImport = null; $('#frame-import-input').val(''); }
            });
        });

        // Delete handlers
        $(document).on("click", ".btn-delete-video", function() {
            if (confirm('Delete this video and ALL labels?')) {
                $.ajax({ url: '/deleteVideo', type: 'POST', contentType: 'application/json', data: JSON.stringify({ video_uuid: $(this).data('uuid') }), success: refreshVideos });
            }
        });
        $(document).on("click", ".btn-delete-dataset", function() {
            if (confirm('Delete this dataset?')) {
                $.ajax({ url: '/deleteDataset', type: 'POST', contentType: 'application/json', data: JSON.stringify({ dataset_uuid: $(this).data('uuid') }), success: refreshDatasets });
            }
        });
         $(document).on("click", ".btn-delete-model", function() {
            if (confirm('Delete this model?')) {
                $.ajax({ url: '/deleteModel', type: 'POST', contentType: 'application/json', data: JSON.stringify({ model_uuid: $(this).data('uuid') }), success: refreshModels });
            }
        });
        $(document).on("click", ".btn-delete-task", function() {
            const videoUuid = $(this).data('video-uuid');
            if (confirm('Delete this task?')) {
                $.ajax({ url: '/deleteTask', type: 'POST', contentType: 'application/json', data: JSON.stringify({ task_uuid: $(this).data('task-uuid') }), success: function() { refreshTasksInModal(videoUuid); } });
            }
        });

        // Dataset Actions
        $(document).on("click", ".btn-regenerate-dataset", function() {
            if (confirm('Update dataset? Old files will be replaced.')) {
                $.ajax({ url: '/regenerateDataset', type: 'POST', contentType: 'application/json', data: JSON.stringify({ dataset_uuid: $(this).data('uuid') }), success: function(res) { if(res.success){ alert('Update started.'); refreshDatasets(); } else alert(res.message); } });
            }
        });

        // Cancel Task
        $(document).on("click", ".btn-cancel-task", function() {
            if (confirm('Cancel running task?')) {
                $.ajax({ url: '/cancelTask', type: 'POST', contentType: 'application/json', data: JSON.stringify({ video_uuid: $(this).data('uuid') }), success: function(res) { if(res.success){ alert('Cancellation requested.'); refreshVideos(); } else alert(res.message); } });
            }
        });

        // Initial Load
        loadSettings();
        function runAllRefreshes() { refreshVideos(); refreshDatasets(); refreshModels(); }
        runAllRefreshes();
        setInterval(runAllRefreshes, 5000);
    });
</script>
{% endblock %}
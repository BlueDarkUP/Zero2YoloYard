<!-- templates/root.html -->
{% extends "layout.html" %}
{% from "_macros.html" import render_modal %}

{% block content %}
<div class="content-wrapper slide-in-up">
    <ul class="nav nav-tabs" id="mainTabs" role="tablist">
        <li class="nav-item"><a class="nav-link active" id="videos-tab" data-toggle="tab" href="#videos" role="tab">Videos</a></li>
        <li class="nav-item"><a class="nav-link" id="datasets-tab" data-toggle="tab" href="#datasets" role="tab">Datasets</a></li>
        <li class="nav-item"><a class="nav-link" id="models-tab" data-toggle="tab" href="#models" role="tab">Models</a></li>
        <li class="nav-item"><a class="nav-link" id="settings-tab" data-toggle="tab" href="#settings" role="tab">Settings</a></li>
    </ul>

    <div class="tab-content pt-4">
        <!-- Videos Tab -->
        <div class="tab-pane fade show active" id="videos" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="mb-0">Videos Management</h2>
                <button class="btn btn-primary" data-toggle="modal" data-target="#uploadVideoModal">
                    <i class="bi bi-upload"></i> Upload Video
                </button>
            </div>
            <p class="text-muted">Upload, manage, and assign annotation tasks for your videos.</p>
            <input type="file" id="frame-import-input" webkitdirectory directory multiple style="display: none;" />
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="thead-light"><tr><th>Description</th><th>Filename</th><th>Status</th><th>Frames</th><th>Labeled</th><th>Actions</th></tr></thead>
                    <tbody id="video-list"></tbody>
                </table>
            </div>
        </div>

        <!-- Datasets Tab -->
        <div class="tab-pane fade" id="datasets" role="tabpanel">
             <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="mb-0">Dataset Hub</h2>
                <button class="btn btn-primary" data-toggle="modal" data-target="#createDatasetModal">
                    <i class="bi bi-plus-circle"></i> Create Dataset
                </button>
            </div>
            <p class="text-muted">Create, analyze, and download your datasets in YOLO format.</p>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="thead-light">
                        <tr>
                            <th>Description</th>
                            <th>Status</th>
                            <th>Included Videos</th>
                            <th>Classes</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="dataset-list"></tbody>
                </table>
            </div>
        </div>

        <!-- Models Tab -->
        <div class="tab-pane fade" id="models" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="mb-0">Model Repository</h2>
                <button class="btn btn-primary" data-toggle="modal" data-target="#importModelModal">
                    <i class="bi bi-box-arrow-in-down"></i> Import TFLite Model
                </button>
            </div>
            <p class="text-muted">Import and manage your trained TFLite models.</p>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="thead-light">
                        <tr>
                            <th>Description</th>
                            <th>Created Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="model-list"></tbody>
                </table>
            </div>
        </div>

        <!-- Settings Tab -->
        <div class="tab-pane fade" id="settings" role="tabpanel">
            <h2 class="mb-3">Application Settings</h2>
            <p class="text-muted">Changes to the SAM model will take effect on the next annotation or tracking task.</p>
            <form id="settings-form" class="mt-4 col-md-10 col-lg-8">
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="bi bi-magic"></i> AI Model Settings
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label for="setting-sam-model"><strong>Annotation Assistance Model (SAM)</strong></label>
                            <select id="setting-sam-model" class="form-control">
                                <option value="sam2.1_t.pt" data-name="SAM 2.1 Tiny">SAM 2.1 Tiny</option>
                                <option value="sam2.1_s.pt" data-name="SAM 2.1 Small">SAM 2.1 Small</option>
                                <option value="sam2.1_b.pt" data-name="SAM 2.1 Base">SAM 2.1 Base</option>
                                <option value="sam2.1_l.pt" data-name="SAM 2.1 Large">SAM 2.1 Large</option>
                            </select>
                            <small class="form-text text-muted">Larger models are more accurate but significantly slower and use more memory.</small>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-gear-fill"></i> General Settings
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label for="setting-jpeg-quality"><strong>Frame Extraction JPEG Quality</strong></label>
                            <input type="number" id="setting-jpeg-quality" class="form-control" min="10" max="100" step="5">
                             <small class="form-text text-muted">Affects disk space usage and image quality for new video uploads (10-100).</small>
                        </div>
                        <div class="form-group">
                            <label for="setting-opencv-tracker"><strong>Default OpenCV Tracker</strong></label>
                            <select id="setting-opencv-tracker" class="form-control">
                                {% for tracker in tracker_fns %}
                                <option value="{{ tracker }}">{{ tracker }}</option>
                                {% endfor %}
                            </select>
                            <small class="form-text text-muted">This is for the legacy object tracking feature.</small>
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary mt-4">
                    <i class="bi bi-check-circle"></i> Save Settings
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Modals -->
{% call render_modal('uploadVideoModal', 'Upload a New Video') %}
    <form id="upload-video-form">
        <div class="form-group">
            <label for="video-description">Description</label>
            <input type="text" class="form-control" id="video-description" name="description" placeholder="A short, unique description" required maxlength="{{ limit_data.MAX_DESCRIPTION_LENGTH }}">
        </div>
        <div class="form-group">
            <label for="video-file">Video File</label>
            <div class="custom-file">
                <input type="file" class="custom-file-input" id="video-file" name="video_file" accept="video/mp4" required>
                <label class="custom-file-label" for="video-file">Choose file...</label>
            </div>
            <small class="form-text text-muted">Max size: {{ limit_data.MAX_VIDEO_SIZE_MB }}MB. Only .mp4 is supported.</small>
        </div>
        <button type="submit" class="btn btn-primary w-100"><i class="bi bi-upload"></i> Upload</button>
    </form>
{% endcall %}

{% call render_modal('createDatasetModal', 'Create a New Dataset') %}
    <form id="create-dataset-form">
        <div class="form-group">
            <label for="dataset-description">Dataset Description</label>
            <input type="text" class="form-control" id="dataset-description" placeholder="Unique description for the dataset" required maxlength="{{ limit_data.MAX_DESCRIPTION_LENGTH }}">
        </div>
        <div class="form-group">
            <label for="dataset-videos">Select Videos (must be READY and have labeled frames)</label>
            <select multiple class="form-control" id="dataset-videos" required size="8">
            </select>
            <small class="form-text text-muted">Hold Ctrl/Cmd to select multiple videos.</small>
        </div>
        <div class="row">
            <div class="form-group col-md-6">
                <label for="eval-percent">Validation Set (%)</label>
                <input type="number" class="form-control" id="eval-percent" value="20" min="5" max="50" step="1">
            </div>
            <div class="form-group col-md-6">
                <label for="test-percent">Test Set (%)</label>
                <input type="number" class="form-control" id="test-percent" value="10" min="0" max="50" step="1">
            </div>
        </div>
        <button type="submit" class="btn btn-primary w-100"><i class="bi bi-plus-circle"></i> Create</button>
    </form>
{% endcall %}

{% call render_modal('importModelModal', 'Import a TFLite Model') %}
    <form id="import-model-form">
        <div class="form-group">
            <label for="model-description">Model Description</label>
            <input type="text" class="form-control" id="model-description" name="description" placeholder="A short, unique description" required maxlength="{{ limit_data.MAX_DESCRIPTION_LENGTH }}">
        </div>
        <div class="form-group">
            <label for="model-file">TFLite File</label>
             <div class="custom-file">
                <input type="file" class="custom-file-input" id="model-file" name="model_file" accept=".tflite" required>
                <label class="custom-file-label" for="model-file">Choose file...</label>
            </div>
            <small class="form-text text-muted">Only .tflite models are supported.</small>
        </div>
        <button type="submit" class="btn btn-primary w-100"><i class="bi bi-box-arrow-in-down"></i> Import</button>
    </form>
{% endcall %}

<div class="modal fade" id="manageTasksModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="manageTasksModalTitle">Manage Annotation Tasks for: </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <h6><i class="bi bi-list-task"></i> Existing Tasks</h6>
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead class="thead-light"><tr><th>Assigned To</th><th>Frame Range</th><th>Description</th><th>Actions</th></tr></thead>
                        <tbody id="task-list-in-modal"></tbody>
                    </table>
                </div>
                <hr class="my-4">
                <h6><i class="bi bi-plus-circle-dotted"></i> Create New Task</h6>
                <form id="create-task-form">
                    <input type="hidden" id="task-video-uuid">
                    <div class="form-row">
                        <div class="form-group col-md-4">
                            <label for="task-assigned-to">Assign To (User)</label>
                            <input type="text" class="form-control" id="task-assigned-to" placeholder="e.g., Alice" required>
                        </div>
                        <div class="form-group col-md-3">
                            <label for="task-start-frame">Start Frame</label>
                            <input type="number" class="form-control" id="task-start-frame" min="0" required>
                        </div>
                        <div class="form-group col-md-3">
                            <label for="task-end-frame">End Frame</label>
                            <input type="number" class="form-control" id="task-end-frame" min="0" required>
                        </div>
                         <div class="form-group col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">Create</button>
                        </div>
                    </div>
                     <div class="form-group">
                        <label for="task-description">Task Description (Optional)</label>
                        <input type="text" class="form-control" id="task-description" placeholder="e.g., Label all cars in daytime scenes">
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // --- Custom File Input Label ---
    $('.custom-file-input').on('change', function() {
       let fileName = $(this).val().split('\\').pop();
       $(this).next('.custom-file-label').addClass("selected").html(fileName);
    });

    // --- Helper Functions ---
    function getStatusBadge(status) {
        let badgeClass = 'secondary';
        if (status === 'READY') badgeClass = 'success';
        if (status === 'PROCESSING' || status === 'EXTRACTING' || status === 'PENDING') badgeClass = 'info';
        if (status === 'FAILED') badgeClass = 'danger';
        return `<span class="badge badge-${badgeClass}">${status}</span>`;
    }

    function showSuccess(message) {
        alert(message);
    }

    function showError(message) {
        alert('Error: ' + message);
    }

    // --- Refresh Functions ---
    function refreshVideos() {
        $.get('/listVideos', function(data) {
            const videoList = $('#video-list');
            videoList.empty();
            data.all_videos.forEach(video => {
                const actionBtnDisabled = video.status !== 'READY' ? 'disabled' : '';
                const row = `
                    <tr class="slide-in-up">
                        <td><strong>${video.description}</strong></td>
                        <td class="text-muted">${video.video_filename || ''}</td>
                        <td>${getStatusBadge(video.status)} <small class="text-muted">${video.status_message || ''}</small></td>
                        <td>${video.extracted_frame_count} / ${video.frame_count || '?'}</td>
                        <td>${video.labeled_frame_count}</td>
                        <td>
                            <button class="btn btn-sm btn-success btn-manage-tasks"
                                    data-uuid="${video.video_uuid}"
                                    data-description="${video.description}"
                                    data-frameCount="${video.frame_count}"
                                    ${actionBtnDisabled}>
                                <i class="bi bi-card-checklist"></i> Manage Tasks
                            </button>
                            <button class="btn btn-sm btn-info btn-import-frames ${actionBtnDisabled}" data-uuid="${video.video_uuid}"><i class="bi bi-images"></i> Import</button>
                            <button class="btn btn-sm btn-danger btn-delete-video" data-uuid="${video.video_uuid}"><i class="bi bi-trash"></i> Delete</button>
                        </td>
                    </tr>`;
                videoList.append(row);
            });

            const datasetVideoSelect = $('#dataset-videos');
            datasetVideoSelect.empty();
            data.ready_videos_for_dataset.forEach(video => {
                 datasetVideoSelect.append(`<option value="${video.video_uuid}">${video.description} (${video.labeled_frame_count} labeled frames)</option>`);
            });
        });
    }

    function refreshDatasets() {
        $.get('/listDatasets', function(data) {
            const datasetList = $('#dataset-list');
            datasetList.empty();
            data.datasets.forEach(dataset => {
                let actions = `<button class="btn btn-sm btn-danger btn-delete-dataset" data-uuid="${dataset.dataset_uuid}"><i class="bi bi-trash"></i> Delete</button>`;
                if (dataset.status === 'READY') {
                    actions = `<a href="/downloadDataset/${dataset.dataset_uuid}" class="btn btn-sm btn-success"><i class="bi bi-download"></i> Download</a> ` +
                              `<a href="/datasetAnalysis/${dataset.dataset_uuid}" class="btn btn-sm btn-info"><i class="bi bi-bar-chart-line"></i> Analyze</a> ` +
                              `<button class="btn btn-sm btn-secondary btn-regenerate-dataset" data-uuid="${dataset.dataset_uuid}"><i class="bi bi-arrow-repeat"></i> Update</button> ` +
                               actions;
                } else if (dataset.status === 'FAILED') {
                    actions = `<button class="btn btn-sm btn-warning btn-regenerate-dataset" data-uuid="${dataset.dataset_uuid}"><i class="bi bi-arrow-repeat"></i> Retry</button> ` + actions;
                }

                const videos = JSON.parse(dataset.video_uuids || '[]').length;
                const classes = JSON.parse(dataset.sorted_label_list || '[]').join(', ');

                const row = `
                    <tr class="slide-in-up">
                        <td><strong>${dataset.description}</strong></td>
                        <td>${getStatusBadge(dataset.status)} <small class="text-muted">${dataset.status_message || ''}</small></td>
                        <td>${videos} video(s)</td>
                        <td class="text-muted">${classes || 'N/A'}</td>
                        <td>${actions}</td>
                    </tr>`;
                datasetList.append(row);
            });
        });
    }

    function refreshModels() {
        $.get('/listModels', function(data) {
            const modelList = $('#model-list');
            modelList.empty();
            data.models.forEach(model => {
                const createdDate = new Date(model.create_time_ms).toLocaleString();
                const row = `
                    <tr class="slide-in-up">
                        <td><strong>${model.description}</strong></td>
                        <td class="text-muted">${createdDate}</td>
                        <td>
                            <button class="btn btn-sm btn-danger btn-delete-model" data-uuid="${model.model_uuid}"><i class="bi bi-trash"></i> Delete</button>
                        </td>
                    </tr>`;
                modelList.append(row);
            });
        });
    }

    function loadSettings() {
        $.get('/api/settings', function(data) {
            if (data.success) {
                const settings = data.settings;
                $('#setting-sam-model').val(settings.sam_model_checkpoint);
                $('#setting-jpeg-quality').val(settings.frame_extraction_jpeg_quality);
                $('#setting-opencv-tracker').val(settings.default_opencv_tracker);
            }
        });
    }

    // --- Form Submission Handlers ---
    $('#upload-video-form').on('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        $.ajax({
            url: '/uploadVideo', type: 'POST', data: formData, processData: false, contentType: false,
            success: function(response) {
                if (response.success) {
                    showSuccess('Video uploaded successfully! Frame extraction has started.');
                    $('#uploadVideoModal').modal('hide');
                    $(this).find('form').trigger('reset');
                    $('.custom-file-label').html('Choose file...');
                    refreshVideos();
                } else { showError(response.message); }
            }.bind(this),
            error: function(xhr) { showError(xhr.responseJSON ? xhr.responseJSON.message : 'An unknown error occurred.'); }
        });
    });

    $('#create-dataset-form').on('submit', function(e) {
        e.preventDefault();
        const datasetData = {
            description: $('#dataset-description').val(),
            video_uuids: $('#dataset-videos').val(),
            eval_percent: $('#eval-percent').val(),
            test_percent: $('#test-percent').val()
        };
        $.ajax({
            url: '/createDataset', type: 'POST', contentType: 'application/json', data: JSON.stringify(datasetData),
            success: function(response) {
                if (response.success) {
                    showSuccess('Dataset creation started!');
                    $('#createDatasetModal').modal('hide');
                    refreshDatasets();
                } else { showError(response.message); }
            },
            error: function(xhr) { showError(xhr.responseJSON ? xhr.responseJSON.message : 'An unknown error occurred.'); }
        });
    });

    $('#import-model-form').on('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        $.ajax({
            url: '/importModel', type: 'POST', data: formData, processData: false, contentType: false,
            success: function(response) {
                if (response.success) {
                    showSuccess('Model imported successfully!');
                    $('#importModelModal').modal('hide');
                    $(this).find('form').trigger('reset');
                    $('.custom-file-label').html('Choose file...');
                    refreshModels();
                } else { showError(response.message); }
            }.bind(this),
            error: function(xhr) { showError(xhr.responseJSON ? xhr.responseJSON.message : 'An unknown error occurred.'); }
        });
    });

    $('#settings-form').on('submit', function(e) {
        e.preventDefault();
        const selectedOption = $('#setting-sam-model').find('option:selected');
        const settingsData = {
            sam_model_checkpoint: selectedOption.val(),
            sam_model_name: selectedOption.data('name'),
            frame_extraction_jpeg_quality: parseInt($('#setting-jpeg-quality').val()),
            default_opencv_tracker: $('#setting-opencv-tracker').val()
        };
        $.ajax({
            url: '/api/settings', type: 'POST', contentType: 'application/json', data: JSON.stringify(settingsData),
            success: function(response) {
                if (response.success) {
                    if (response.restart_required) {
                        alert("Settings saved! The SAM model was changed. The new model will be loaded automatically for the next task.");
                    } else {
                        alert("Settings saved successfully!");
                    }
                } else { showError(response.message); }
            },
            error: function(xhr) { showError(xhr.responseJSON ? xhr.responseJSON.message : 'An unknown error occurred.'); }
        });
    });

    // --- Task Management ---
    $(document).on("click", ".btn-manage-tasks", function() {
        const videoUuid = $(this).data("uuid");
        const videoDesc = $(this).data("description");
        const frameCount = $(this).data("framecount");
        $('#manageTasksModalTitle').text('Manage Annotation Tasks for: ' + videoDesc);
        $('#task-video-uuid').val(videoUuid);
        $('#task-start-frame').attr('max', frameCount - 1);
        $('#task-end-frame').attr('max', frameCount - 1);
        refreshTasksInModal(videoUuid);
        $('#manageTasksModal').modal('show');
    });

    function refreshTasksInModal(videoUuid) {
        const taskListBody = $('#task-list-in-modal');
        taskListBody.empty().append('<tr><td colspan="4">Loading...</td></tr>');
        $.get(`/listTasks?video_uuid=${videoUuid}`, function(data) {
            taskListBody.empty();
            if (data.success && data.tasks.length > 0) {
                data.tasks.forEach(task => {
                    const row = `
                        <tr class="slide-in-up">
                            <td>${task.assigned_to}</td>
                            <td>${task.start_frame} - ${task.end_frame}</td>
                            <td>${task.description || ''}</td>
                            <td>
                                <a href="/labelVideo?task_uuid=${task.task_uuid}" class="btn btn-sm btn-primary"><i class="bi bi-pencil-square"></i> Label</a>
                                <button class="btn btn-sm btn-danger btn-delete-task" data-task-uuid="${task.task_uuid}" data-video-uuid="${videoUuid}"><i class="bi bi-trash"></i></button>
                            </td>
                        </tr>`;
                    taskListBody.append(row);
                });
            } else {
                taskListBody.append('<tr><td colspan="4">No tasks created for this video yet.</td></tr>');
            }
        });
    }

    $('#create-task-form').on('submit', function(e) {
        e.preventDefault();
        const videoUuid = $('#task-video-uuid').val();
        const taskData = { video_uuid: videoUuid, assigned_to: $('#task-assigned-to').val(), description: $('#task-description').val(), start_frame: $('#task-start-frame').val(), end_frame: $('#task-end-frame').val(), };
        $.ajax({
            url: '/createTask', type: 'POST', contentType: 'application/json', data: JSON.stringify(taskData),
            success: function(response) {
                if (response.success) {
                    showSuccess('Task created successfully!');
                    $('#create-task-form')[0].reset();
                    refreshTasksInModal(videoUuid);
                } else { showError(response.message); }
            },
            error: function() { showError('An error occurred while creating the task.'); }
        });
    });

    // --- [RESTORED] Frame Import Functionality ---
    let videoUuidForImport = null;
    $(document).on("click", ".btn-import-frames", function() {
        videoUuidForImport = $(this).data('uuid');
        $('#frame-import-input').click(); // Trigger the hidden file input
    });

    $('#frame-import-input').on('change', function(e) {
        if (!videoUuidForImport || e.target.files.length === 0) {
            return;
        }
        const files = e.target.files;
        const formData = new FormData();
        formData.append('video_uuid', videoUuidForImport);
        for (let i = 0; i < files.length; i++) {
            formData.append('frame_files', files[i]);
        }

        alert(`Importing ${files.length} frames. This might take a moment...`);

        $.ajax({
            url: '/importFrames',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.success) {
                    showSuccess(`${response.imported_count} frames imported successfully!`);
                    refreshVideos();
                } else {
                    showError(response.message);
                }
            },
            error: function(xhr) {
                showError(xhr.responseJSON ? xhr.responseJSON.message : 'An unknown error occurred during import.');
            },
            complete: function() {
                // Reset for next use
                videoUuidForImport = null;
                $('#frame-import-input').val('');
            }
        });
    });


    // --- Deletion and Update Handlers ---
    $(document).on("click", ".btn-delete-video", function() {
        if (confirm('Are you sure you want to delete this video and all its data?')) { $.ajax({url: '/deleteVideo', type: 'POST', contentType: 'application/json', data: JSON.stringify({ video_uuid: $(this).data('uuid') }), success: refreshVideos }); }
    });
    $(document).on("click", ".btn-delete-task", function() {
        const videoUuid = $(this).data('video-uuid');
        if (confirm('Are you sure you want to delete this task?')) { $.ajax({url: '/deleteTask', type: 'POST', contentType: 'application/json', data: JSON.stringify({ task_uuid: $(this).data('task-uuid') }), success: function() { refreshTasksInModal(videoUuid); } }); }
    });
    $(document).on("click", ".btn-delete-dataset", function() {
        if (confirm('Are you sure you want to delete this dataset?')) { $.ajax({url: '/deleteDataset', type: 'POST', contentType: 'application/json', data: JSON.stringify({ dataset_uuid: $(this).data('uuid') }), success: refreshDatasets }); }
    });
    $(document).on("click", ".btn-delete-model", function() {
        if (confirm('Are you sure you want to delete this model?')) { $.ajax({url: '/deleteModel', type: 'POST', contentType: 'application/json', data: JSON.stringify({ model_uuid: $(this).data('uuid') }), success: refreshModels }); }
    });

    $(document).on("click", ".btn-regenerate-dataset", function() {
        const uuid = $(this).data('uuid');
        if (confirm('Are you sure you want to update this dataset? This will delete the old zip file and regenerate it with the latest annotations.')) {
            $.ajax({
                url: '/regenerateDataset',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ dataset_uuid: uuid }),
                success: function(response) {
                    if(response.success) {
                        alert('Dataset update process has started.');
                        refreshDatasets();
                    } else {
                        alert('Error: ' + response.message);
                    }
                },
                error: function() {
                    alert('An error occurred while starting the dataset update.');
                }
            });
        }
    });

    // --- Initial Load & Refresh Interval ---
    function runAllRefreshes() {
        refreshVideos();
        refreshDatasets();
        refreshModels();
    }

    loadSettings();
    runAllRefreshes();
    setInterval(runAllRefreshes, 5000);
});
</script>
{% endblock %}
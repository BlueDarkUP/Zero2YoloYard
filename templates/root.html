{% extends "layout.html" %}
{% from "_macros.html" import render_modal %}

{% block content %}
<div class="container-fluid px-4 px-lg-5 content-wrapper fade-in">

    <!-- Page Header: 工业/终端风格 -->
    <!-- 修改点：增加了 mt-4 (顶部外边距) 和 pt-2 (顶部内边距) 拉开与导航栏的距离 -->
<div class="d-flex flex-column flex-md-row justify-content-between align-items-md-end page-header border-bottom border-dark pb-3 mb-4 mt-4 pt-2" style="border-color: var(--border-color) !important;">
    <div>
        <h1 class="page-title mb-0 text-uppercase" style="text-shadow: 0 0 10px rgba(255,255,255,0.1);">
            <i class="bi bi-speedometer2 mr-2 text-primary"></i>Dashboard
        </h1>
        <p class="page-subtitle font-monospace text-muted small mb-0">
            // SYSTEM_READY // PIPELINE_ACTIVE
        </p>
    </div>

    <!-- Tab 导航 -->
    <ul class="nav nav-tabs mt-3 mt-md-0 border-0" id="mainTabs" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" id="videos-tab" data-toggle="tab" href="#videos" role="tab" aria-selected="true">
                [ VIDEOS ]
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="datasets-tab" data-toggle="tab" href="#datasets" role="tab" aria-selected="false">
                [ DATASETS ]
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="models-tab" data-toggle="tab" href="#models" role="tab" aria-selected="false">
                [ MODELS ]
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="settings-tab" data-toggle="tab" href="#settings" role="tab" aria-selected="false">
                [ SETTINGS ]
            </a>
        </li>
    </ul>
</div>

    <div class="tab-content" id="mainTabContent">

        <!-- VIDEOS TAB -->
        <div class="tab-pane fade show active" id="videos" role="tabpanel">
            <div class="d-flex justify-content-end mb-3">
                <button class="btn btn-primary" data-toggle="modal" data-target="#uploadVideoModal">
                    <i class="bi bi-plus-lg mr-2"></i>INIT_NEW_VIDEO
                </button>
            </div>

            <input type="file" id="frame-import-input" multiple accept="image/*,video/mp4,video/x-m4v,video/*" style="display: none;" />

            <!-- 使用标准的 card 类以应用 CSS 中的 HUD 装饰 -->
            <div class="card">
                <div class="card-header">
                    <span class="text-uppercase small font-weight-bold tracking-wider">Video Registry</span>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th style="width: 25%">Description</th>
                                <th>Filename</th>
                                <th>Status</th>
                                <th>Progress</th>
                                <th>Labels</th>
                                <th class="text-right">Operations</th>
                            </tr>
                        </thead>
                        <tbody id="video-list"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- DATASETS TAB -->
        <div class="tab-pane fade" id="datasets" role="tabpanel">
            <div class="d-flex justify-content-end mb-3">
                <button class="btn btn-primary" data-toggle="modal" data-target="#createDatasetModal">
                    <i class="bi bi-plus-lg mr-2"></i>COMPILE_DATASET
                </button>
            </div>

            <div class="card">
                <div class="card-header">
                     <span class="text-uppercase small font-weight-bold tracking-wider">Dataset Archives</span>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th style="width: 25%">ID / Name</th>
                                <th>Status</th>
                                <th>Composition</th>
                                <th>Classes</th>
                                <th class="text-right">Operations</th>
                            </tr>
                        </thead>
                        <tbody id="dataset-list"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- MODELS TAB -->
        <div class="tab-pane fade" id="models" role="tabpanel">
            <div class="d-flex justify-content-end mb-3">
                <button class="btn btn-primary" data-toggle="modal" data-target="#importModelModal">
                    <i class="bi bi-upload mr-2"></i>LOAD_MODEL
                </button>
            </div>

            <div class="card">
                <div class="card-header">
                     <span class="text-uppercase small font-weight-bold tracking-wider">Inference Engines</span>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th>Architecture</th>
                                <th>Map File</th>
                                <th>Timestamp</th>
                                <th class="text-right">Operations</th>
                            </tr>
                        </thead>
                        <tbody id="model-list"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- SETTINGS TAB -->
        <div class="tab-pane fade" id="settings" role="tabpanel">
            <form id="settings-form">
                <div class="row justify-content-center">
                    <div class="col-lg-10 col-xl-9">

                        <!-- Settings Section 1 -->
                        <div class="card settings-section mb-4">
                            <div class="card-header text-primary">
                                <i class="bi bi-cpu mr-2"></i> SYSTEM_HARDWARE_CONFIG
                            </div>
                            <div class="card-body">
                                <div class="form-row">
                                    <div class="form-group col-md-6">
                                        <label class="small text-muted font-weight-bold">COMPUTATION_NODE</label>
                                        <select id="setting-gpu-device" class="form-control custom-select">
                                            <option value="auto">AUTO_DETECT</option>
                                            <option value="cpu">CPU_ONLY</option>
                                            <option value="cuda:0">NVIDIA_CUDA_0</option>
                                            <option value="cuda:1">NVIDIA_CUDA_1</option>
                                        </select>
                                    </div>
                                    <div class="form-group col-md-6">
                                        <label class="small text-muted font-weight-bold">SEGMENTATION_CORE (SAM)</label>
                                        <select id="setting-sam-model" class="form-control custom-select">
                                            <option value="sam2.1_t.pt" data-name="SAM 2.1 Tiny">SAM 2.1 TINY (LOW_LATENCY)</option>
                                            <option value="sam2.1_s.pt" data-name="SAM 2.1 Small">SAM 2.1 SMALL (BALANCED)</option>
                                            <option value="sam2.1_b.pt" data-name="SAM 2.1 Base">SAM 2.1 BASE (STANDARD)</option>
                                            <option value="sam2.1_l.pt" data-name="SAM 2.1 Large">SAM 2.1 LARGE (HIGH_PRECISION)</option>
                                        </select>
                                    </div>
                                    <div class="form-group col-md-6">
                                        <label class="small text-muted font-weight-bold">FEATURE_EXTRACTOR</label>
                                        <select id="setting-feature-extractor-model" class="form-control custom-select">
                                            <option value="mobilenet_v3_large">MOBILENET_V3_LARGE</option>
                                            <option value="mobilenet_v3_small">MOBILENET_V3_SMALL</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Settings Section 2 -->
                        <div class="card settings-section mb-4">
                            <div class="card-header text-primary">
                                <i class="bi bi-sliders mr-2"></i> ALGORITHM_PARAMETERS
                            </div>
                            <div class="card-body">
                                <div class="form-row">
                                    <div class="form-group col-md-4">
                                        <label class="d-flex justify-content-between small text-muted font-weight-bold">
                                            MASK_CONFIDENCE <span id="sam-mask-conf-val" class="text-primary font-monospace">0.35</span>
                                        </label>
                                        <input type="range" class="custom-range" id="setting-sam-mask-confidence" min="0.1" max="0.9" step="0.05">
                                    </div>
                                    <div class="form-group col-md-4">
                                        <label class="d-flex justify-content-between small text-muted font-weight-bold">
                                            NMS_IOU_THRESH <span id="nms-iou-val" class="text-primary font-monospace">0.70</span>
                                        </label>
                                        <input type="range" class="custom-range" id="setting-nms-iou-threshold" min="0.1" max="1.0" step="0.05">
                                    </div>
                                    <div class="form-group col-md-4">
                                        <label class="d-flex justify-content-between small text-muted font-weight-bold">
                                            PROTO_TEMP <span id="prototype-temp-val" class="text-primary font-monospace">0.07</span>
                                        </label>
                                        <input type="range" class="custom-range" id="setting-prototype-temperature" min="0.01" max="0.5" step="0.01">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Settings Section 3 -->
                        <div class="card settings-section mb-4">
                            <div class="card-header text-primary">
                                <i class="bi bi-ui-checks mr-2"></i> WORKFLOW_PROTOCOLS
                            </div>
                            <div class="card-body">
                                <div class="form-row">
                                    <div class="form-group col-md-6">
                                        <label class="small text-muted font-weight-bold">DEFAULT_TOOL</label>
                                        <select id="setting-default-annotation-mode" class="form-control custom-select">
                                            <option value="manual">MANUAL_DRAW</option>
                                            <option value="sam">SAM (POINT_CLICK)</option>
                                            <option value="lam">LAM (TEXT_PROMPT)</option>
                                            <option value="smart_select">SMART_SELECT</option>
                                        </select>
                                    </div>
                                    <div class="form-group col-md-6">
                                        <label class="small text-muted font-weight-bold">AUTO_SAVE</label>
                                        <div class="custom-control custom-switch mt-2">
                                            <input type="checkbox" class="custom-control-input" id="setting-autosave-enabled">
                                            <label class="custom-control-label font-monospace" for="setting-autosave-enabled">SAVE_ON_NAV</label>
                                        </div>
                                    </div>
                                    <div class="form-group col-md-6">
                                        <label class="small text-muted font-weight-bold">COMPRESSION_QUALITY</label>
                                        <input type="number" id="setting-jpeg-quality" class="form-control" min="10" max="100" step="5">
                                    </div>
                                    <div class="form-group col-md-6">
                                        <label class="small text-muted font-weight-bold">LEGACY_TRACKER</label>
                                        <select id="setting-opencv-tracker" class="form-control custom-select">
                                            {% for tracker in tracker_fns %}<option value="{{ tracker }}">{{ tracker }}</option>{% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Settings Section 4 -->
                        <div class="card settings-section mb-4">
                             <div class="card-header text-primary">
                                <i class="bi bi-palette mr-2"></i> SIGNAL_COLORS (CLASS_MAP)
                            </div>
                            <div class="card-body">
                                 <div id="class-color-manager" class="d-flex flex-wrap custom-scrollbar" style="max-height: 200px; overflow-y: auto; gap: 10px;"></div>
                            </div>
                        </div>

                        <!-- Maintenance Section -->
                        <div class="card settings-section mb-4" style="border-color: var(--color-danger);">
                            <div class="card-header text-danger">
                                <i class="bi bi-tools mr-2"></i> SYSTEM_MAINTENANCE
                            </div>
                            <div class="card-body">
                                <div class="d-flex align-items-center justify-content-between">
                                    <div class="form-group mb-0 mr-3 flex-grow-1">
                                        <label class="small text-muted font-weight-bold">CACHE_FLUSH_INTERVAL (SEC)</label>
                                        <input type="number" class="form-control" id="setting-cache-save-interval" min="10" max="300">
                                    </div>
                                    <button type="button" class="btn btn-outline-danger" id="clear-cache-btn">
                                        <i class="bi bi-eraser-fill mr-1"></i> PURGE_CACHE
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="text-right pb-5">
                            <button type="submit" class="btn btn-primary px-4">
                                COMMIT_CHANGES
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modals: 保持结构，但在 CSS 中已去除圆角和阴影 -->
{% call render_modal('uploadVideoModal', 'UPLOAD_NEW_VIDEO') %}
<form id="upload-video-form">
    <div class="form-group">
        <label class="font-weight-bold small text-muted">DESCRIPTION</label>
        <input type="text" class="form-control" id="video-description" name="description" placeholder="IDENTIFIER_CODE..." required maxlength="{{ limit_data.MAX_DESCRIPTION_LENGTH }}">
    </div>
    <div class="form-group">
        <label class="font-weight-bold small text-muted">SOURCE_FILE (.MP4)</label>
        <div class="custom-file">
            <input type="file" class="custom-file-input" id="video-file" name="video_file" accept="video/mp4" required>
            <label class="custom-file-label" for="video-file">SELECT_DATA_STREAM...</label>
        </div>
    </div>
    <button type="submit" class="btn btn-primary btn-block">INITIATE_UPLOAD</button>
</form>
{% endcall %}

{% call render_modal('createDatasetModal', 'COMPILE_DATASET') %}
<form id="create-dataset-form">
    <div class="form-group">
        <label class="font-weight-bold small text-muted">DESIGNATION</label>
        <input type="text" class="form-control" id="dataset-description" placeholder="DS_ID_2049..." required maxlength="{{ limit_data.MAX_DESCRIPTION_LENGTH }}">
    </div>
    <div class="form-group">
        <label class="font-weight-bold small text-muted">SOURCE_VIDEOS</label>
        <select multiple class="form-control custom-select" id="dataset-videos" required size="5"></select>
        <small class="text-muted font-monospace">CMD/CTRL+CLICK TO MULTI-SELECT</small>
    </div>
    <div class="form-row">
        <div class="form-group col-6">
            <label class="font-weight-bold small text-muted">VALIDATION %</label>
            <input type="number" class="form-control" id="eval-percent" value="20">
        </div>
        <div class="form-group col-6">
            <label class="font-weight-bold small text-muted">TESTING %</label>
            <input type="number" class="form-control" id="test-percent" value="10">
        </div>
    </div>

    <div class="card mb-3 border-secondary" style="background: rgba(255,255,255,0.02);">
        <div class="card-body p-3">
            <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0 font-weight-bold text-uppercase">Data Augmentation</h6>
                <div class="custom-control custom-switch">
                    <input type="checkbox" class="custom-control-input" id="aug-enabled">
                    <label class="custom-control-label" for="aug-enabled"></label>
                </div>
            </div>
            <div id="augmentation-options-panel" class="mt-3" style="display: none;">
                <div class="form-group">
                    <label class="small text-muted font-weight-bold">REPLICATION_FACTOR</label>
                    <input type="number" class="form-control" id="aug-multiply-factor" value="3">
                </div>
                {% include '_augmentation_controls.html' %}
            </div>
        </div>
    </div>
    <button type="submit" class="btn btn-primary btn-block">EXECUTE_COMPILATION</button>
</form>
{% endcall %}

{% call render_modal('importModelModal', 'IMPORT_MODEL') %}
<form id="import-model-form">
    <div class="form-group">
        <label class="font-weight-bold small text-muted">DESCRIPTION</label>
        <input type="text" class="form-control" id="model-description" name="description" required maxlength="{{ limit_data.MAX_DESCRIPTION_LENGTH }}">
    </div>
    <div class="form-group">
        <label class="font-weight-bold small text-muted">MODEL_BINARY (.TFLITE)</label>
        <div class="custom-file">
            <input type="file" class="custom-file-input" id="model-file" name="model_file" accept=".tflite" required>
            <label class="custom-file-label" for="model-file">SELECT_FILE...</label>
        </div>
    </div>
    <div class="form-group">
        <label class="font-weight-bold small text-muted">LABEL_MAP (.TXT)</label>
        <div class="custom-file">
            <input type="file" class="custom-file-input" id="label-file" name="label_file" accept=".txt,.labels" required>
            <label class="custom-file-label" for="label-file">SELECT_FILE...</label>
        </div>
    </div>
    <div class="form-group">
        <label class="font-weight-bold small text-muted">ARCHITECTURE_TYPE</label>
        <select class="form-control custom-select" id="model-type" name="model_type" required>
            <option value="float32">FLOAT32 (STANDARD)</option>
            <option value="uint8">UINT8 (EDGE_TPU_ACCEL)</option>
        </select>
    </div>
    <button type="submit" class="btn btn-primary btn-block">IMPORT_ENGINE</button>
</form>
{% endcall %}

{% call render_modal('preAnnotateModal', 'AUTO_LABELING_SEQUENCE') %}
<form id="pre-annotate-form">
    <input type="hidden" id="pre-annotate-video-uuid" data-frame-count="0" data-labeled-count="0">
    <div class="form-group">
        <label class="font-weight-bold small text-muted">INFERENCE_MODEL</label>
        <select id="pre-annotate-model-select" class="form-control custom-select" required></select>
    </div>
    <div class="form-row">
        <div class="form-group col-6">
            <label class="font-weight-bold small text-muted">START_FRAME</label>
            <input type="number" id="pre-annotate-start-frame" class="form-control">
        </div>
        <div class="form-group col-6">
            <label class="font-weight-bold small text-muted">END_FRAME</label>
            <input type="number" id="pre-annotate-end-frame" class="form-control">
        </div>
    </div>
    <div class="form-group">
        <label class="d-flex justify-content-between font-weight-bold small text-muted">
            CONFIDENCE_THRESHOLD <span id="confidence-value" class="text-primary font-monospace">0.5</span>
        </label>
        <input type="range" class="custom-range" id="pre-annotate-confidence" min="0.1" max="0.95" step="0.05" value="0.5">
    </div>
    <div class="form-group">
         <label class="font-weight-bold d-block mb-2 small text-muted">MERGE_STRATEGY</label>
         <div class="custom-control custom-radio custom-control-inline">
            <input type="radio" id="strategy-overwrite" name="merge_strategy" value="overwrite" class="custom-control-input" checked>
            <label class="custom-control-label" for="strategy-overwrite">OVERWRITE_EXISTING</label>
        </div>
        <div class="custom-control custom-radio custom-control-inline">
            <input type="radio" id="strategy-skip" name="merge_strategy" value="skip_labeled" class="custom-control-input">
            <label class="custom-control-label" for="strategy-skip">FILL_GAPS_ONLY</label>
        </div>
    </div>
    <button type="submit" class="btn btn-primary btn-block">ENGAGE_AUTO_LABELER</button>
</form>
{% endcall %}

<div class="modal fade" id="manageTasksModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title font-weight-bold text-uppercase" id="manageTasksModalTitle">Task Allocation</h5>
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body pt-3">
                <div class="table-responsive mb-4">
                    <table class="table table-sm table-hover mb-0">
                        <thead>
                            <tr>
                                <th>OPERATOR</th>
                                <th>RANGE</th>
                                <th>NOTES</th>
                                <th class="text-right">ACT</th>
                            </tr>
                        </thead>
                        <tbody id="task-list-in-modal"></tbody>
                    </table>
                </div>
                <h6 class="font-weight-bold mb-3 text-uppercase text-primary border-bottom border-secondary pb-1">Assign New Task</h6>
                <form id="create-task-form">
                    <input type="hidden" id="task-video-uuid">
                    <div class="form-row">
                        <div class="form-group col-md-4">
                            <input type="text" class="form-control form-control-sm" id="task-assigned-to" placeholder="OPERATOR_ID" required>
                        </div>
                        <div class="form-group col-md-3">
                            <input type="number" class="form-control form-control-sm" id="task-start-frame" placeholder="START" required>
                        </div>
                        <div class="form-group col-md-3">
                            <input type="number" class="form-control form-control-sm" id="task-end-frame" placeholder="END" required>
                        </div>
                        <div class="form-group col-md-2">
                            <button type="submit" class="btn btn-sm btn-success btn-block">ASSIGN</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        $('.modal').appendTo("body");
        let currentSettings = {};

        // 自定义文件上传输入框样式逻辑
        $('.custom-file-input').on('change', function() {
            let fileName = $(this).val().split('\\').pop();
            $(this).next('.custom-file-label').addClass("selected").html(fileName);
        });

        // 状态徽章生成逻辑
        function getStatusBadge(status, message) {
            let badgeClass = 'secondary';
            let icon = '';

            if (status === 'READY') {
                badgeClass = 'success'; // 荧光绿
                if(!message) badgeClass = 'success';
                icon = '<i class="bi bi-check2-square mr-1"></i>';
            } else if (['PROCESSING', 'EXTRACTING', 'PENDING', 'PRE_ANNOTATING', 'APPLYING_PROTOTYPES'].includes(status)) {
                badgeClass = 'info'; // 赛博蓝
                icon = '<span class="spinner-border spinner-border-sm mr-1" style="border-width: 1px;"></span>';
            } else if (status === 'CANCELLING') {
                badgeClass = 'warning'; // 工业黄
                icon = '<i class="bi bi-x-octagon mr-1"></i>';
            } else if (status === 'FAILED') {
                badgeClass = 'danger'; // 警报红
                icon = '<i class="bi bi-exclamation-triangle-fill mr-1"></i>';
            }

            // 使用 font-monospace 增强机械感
            return `<span class="badge badge-${badgeClass} font-monospace d-inline-flex align-items-center">${icon} ${status}</span>`;
        }

        function showSuccess(message) { alert(message); } // 建议后期替换为自定义的 HUD Toast
        function showError(message) { alert('SYSTEM ERROR: ' + message); }

        function refreshVideos() {
            $.get('/listVideos', function(data) {
                const videoList = $('#video-list');
                videoList.empty();
                data.all_videos.forEach(video => {
                    const isReady = video.status === 'READY';

                    let actions = '';
                    if (isReady) {
                        // 移除内联 style，使用 CSS 类
                        actions += `<button class="btn btn-sm btn-outline-info btn-import-frames mr-1" data-uuid="${video.video_uuid}" title="IMPORT FRAMES"><i class="bi bi-images"></i></button>`;
                        actions += `<button class="btn btn-sm btn-outline-warning btn-pre-annotate mr-1" data-uuid="${video.video_uuid}" data-frame-count="${video.frame_count}" data-labeled-count="${video.labeled_frame_count}" title="AUTO-LABEL"><i class="bi bi-robot"></i></button>`;
                        actions += `<button class="btn btn-sm btn-outline-success btn-manage-tasks mr-1" data-uuid="${video.video_uuid}" data-description="${video.description}" data-framecount="${video.frame_count}" title="TASKS"><i class="bi bi-list-check"></i></button>`;
                    } else {
                         actions += `<button class="btn btn-sm btn-outline-secondary mr-1" disabled><i class="bi bi-images"></i></button>`;
                    }

                    if (['PRE_ANNOTATING', 'APPLYING_PROTOTYPES'].includes(video.status)) {
                        actions += `<button class="btn btn-sm btn-danger btn-cancel-task mr-1" data-uuid="${video.video_uuid}" title="ABORT"><i class="bi bi-stop-circle"></i></button>`;
                    }

                    actions += `<button class="btn btn-sm btn-outline-danger btn-delete-video" data-uuid="${video.video_uuid}" title="PURGE"><i class="bi bi-trash"></i></button>`;

                    const progress = video.extracted_frame_count ? `${video.extracted_frame_count} / ${video.frame_count || '?'}` : '-';
                    const statusHtml = getStatusBadge(video.status, video.status_message);
                    const statusMsg = video.status_message ? `<div class="small text-muted mt-1 font-monospace">> ${video.status_message}</div>` : '';

                    const row = `
                        <tr>
                            <td class="align-middle font-weight-bold text-white">${video.description}</td>
                            <td class="align-middle text-muted small font-monospace">${video.video_filename || ''}</td>
                            <td class="align-middle">${statusHtml}${statusMsg}</td>
                            <td class="align-middle font-weight-bold text-primary font-monospace small">${progress}</td>
                            <td class="align-middle"><span class="badge badge-secondary font-monospace">${video.labeled_frame_count}</span></td>
                            <td class="align-middle text-right">${actions}</td>
                        </tr>`;
                    videoList.append(row);
                });

                const datasetVideoSelect = $('#dataset-videos');
                datasetVideoSelect.empty();
                data.ready_videos_for_dataset.forEach(video => {
                    datasetVideoSelect.append(`<option value="${video.video_uuid}">${video.description} [FRAMES: ${video.labeled_frame_count}]</option>`);
                });
            });
        }

        function refreshDatasets() {
            $.get('/listDatasets', function(data) {
                const datasetList = $('#dataset-list');
                datasetList.empty();
                data.datasets.forEach(dataset => {
                    let actions = '';
                    if (dataset.status === 'READY') {
                        actions += `<a href="/downloadDataset/${dataset.dataset_uuid}" class="btn btn-sm btn-outline-success mr-1" title="DOWNLOAD"><i class="bi bi-download"></i></a>`;
                        actions += `<a href="/datasetAnalysis/${dataset.dataset_uuid}" class="btn btn-sm btn-outline-info mr-1" title="ANALYZE"><i class="bi bi-bar-chart-line"></i></a>`;
                        actions += `<button class="btn btn-sm btn-outline-secondary btn-regenerate-dataset mr-1" data-uuid="${dataset.dataset_uuid}" title="RECOMPILE"><i class="bi bi-arrow-repeat"></i></button>`;
                    } else if (dataset.status === 'FAILED') {
                         actions += `<button class="btn btn-sm btn-outline-warning btn-regenerate-dataset mr-1" data-uuid="${dataset.dataset_uuid}" title="RETRY"><i class="bi bi-arrow-repeat"></i></button>`;
                    }
                    actions += `<button class="btn btn-sm btn-outline-danger btn-delete-dataset" data-uuid="${dataset.dataset_uuid}" title="DELETE"><i class="bi bi-trash"></i></button>`;

                    const videosCount = JSON.parse(dataset.video_uuids || '[]').length;

                    const classes = JSON.parse(dataset.sorted_label_list || '[]')
                        .map(c => `<span class="badge badge-secondary mr-1 mb-1 font-monospace">${c}</span>`).join('');

                    const row = `
                        <tr>
                            <td class="align-middle font-weight-bold text-white">${dataset.description}</td>
                            <td class="align-middle">${getStatusBadge(dataset.status, dataset.status_message)}</td>
                            <td class="align-middle font-monospace">${videosCount} SOURCES</td>
                            <td class="align-middle" style="line-height: 1.8;">${classes || '<span class="text-muted small">NO_LABELS</span>'}</td>
                            <td class="align-middle text-right">${actions}</td>
                        </tr>`;
                    datasetList.append(row);
                });
            });
        }

        function refreshModels() {
            $.get('/listModels', function(data) {
                const modelList = $('#model-list');
                modelList.empty();
                data.models.forEach(model => {
                    const createdDate = new Date(model.create_time_ms).toLocaleDateString();
                    const typeBadge = model.model_type === 'uint8'
                        ? `<span class="badge badge-info font-monospace">INT8_TPU</span>`
                        : `<span class="badge badge-primary font-monospace">FP32_STD</span>`;

                    const row = `
                        <tr>
                            <td class="align-middle font-weight-bold text-white">${model.description}</td>
                            <td class="align-middle">${typeBadge}</td>
                            <td class="align-middle text-muted small font-monospace">${model.label_filename || 'N/A'}</td>
                            <td class="align-middle text-muted small font-monospace">${createdDate}</td>
                            <td class="align-middle text-right">
                                <button class="btn btn-sm btn-outline-danger btn-delete-model" data-uuid="${model.model_uuid}"><i class="bi bi-trash"></i></button>
                            </td>
                        </tr>`;
                    modelList.append(row);
                });
            });
        }

        function loadSettings() {
            $.get('/api/settings', function(data) {
                if (data.success) {
                    currentSettings = data.settings;
                    const s = data.settings;

                    $('#setting-gpu-device').val(s.gpu_device);
                    $('#setting-sam-model').val(s.sam_model_checkpoint);
                    $('#setting-feature-extractor-model').val(s.feature_extractor_model_name);
                    $('#setting-sam-mask-confidence').val(s.sam_mask_confidence).trigger('input');
                    $('#setting-nms-iou-threshold').val(s.nms_iou_threshold).trigger('input');
                    $('#setting-prototype-temperature').val(s.prototype_temperature).trigger('input');
                    $('#setting-prototype-sample-limit').val(s.prototype_sample_limit);
                    $('#setting-batch-tracking-imgsz').val(s.batch_tracking_imgsz);
                    $('#setting-batch-tracking-conf').val(s.batch_tracking_conf).trigger('input');
                    $('#setting-batch-tracking-chunk-size').val(s.batch_tracking_chunk_size);
                    $('#setting-default-annotation-mode').val(s.default_annotation_mode);
                    $('#setting-autosave-enabled').prop('checked', s.autosave_enabled);
                    $('#setting-preannotation-conf').val(s.default_preannotation_conf).trigger('input');
                    $('#setting-jpeg-quality').val(s.frame_extraction_jpeg_quality);
                    $('#setting-opencv-tracker').val(s.default_opencv_tracker);
                    $('#setting-cache-save-interval').val(s.cache_save_interval_seconds);

                    loadClassColorManager();
                }
            });
        }

        function loadClassColorManager() {
            $.get('/listClasses', function(data) {
                if (data.success) {
                    const container = $('#class-color-manager');
                    container.empty();
                    if (data.labels.length === 0) {
                        container.html('<p class="text-muted small pl-2 font-monospace">NO_CLASSES_DETECTED. INITIATE_ANNOTATION_FIRST.</p>');
                        return;
                    }
                    const classColors = currentSettings.class_colors || {};
                    data.labels.forEach(label => {
                        const color = classColors[label] || '#000000';
                        // 去除 rounded 类，改为直角
                        const item = `
                        <div class="d-flex align-items-center bg-dark border border-secondary px-2 py-1 mr-2 mb-2" style="min-width: 120px;">
                            <input type="color" class="border-0 p-0 mr-2" value="${color}" data-class-name="${label}"
                                   style="width: 24px; height: 24px; cursor: pointer; background: none;" title="COLOR_CODE: ${label}">
                            <span class="small font-weight-bold text-truncate text-white font-monospace" style="max-width: 100px;">${label}</span>
                        </div>`;
                        container.append(item);
                    });
                }
            });
        }

        // Augmentation setup logic (unchanged functionality, just check styles via global css)
        function setupAugmentationListeners(contextSelector) {
            const context = $(contextSelector);
            context.on('input', 'input[type="range"]', function() {
                $(this).closest('div').find('.val-display').text($(this).val());
            });
            context.on('change', '.aug-option input[type="checkbox"]', function() {
                const controlsId = $(this).closest('.aug-option').data('controls');
                context.find('#' + controlsId).toggle($(this).is(':checked'));
            });
            context.find('.aug-option input[type="checkbox"]').each(function() {
                const controlsId = $(this).closest('.aug-option').data('controls');
                context.find('#' + controlsId).toggle($(this).is(':checked'));
            });
        }
        $('#aug-enabled').on('change', function() {
            $('#augmentation-options-panel').slideToggle($(this).is(':checked'));
        });
        setupAugmentationListeners('#createDatasetModal');

        // Helper to get aug options
        function getAugmentationOptions(contextSelector) {
            const context = $(contextSelector);
            const getVal = (selector, type = 'float') => type === 'int' ? parseInt(context.find(selector).val()) : parseFloat(context.find(selector).val());
            const isEnabled = (selector) => context.find(selector).is(':checked');
            // ... (Mapping remains the same as original)
             return {
                enabled: isEnabled('#aug-enabled'),
                multiply_factor: getVal('#aug-multiply-factor', 'int'),
                hflip: { enabled: isEnabled('#aug-hflip-enabled'), p: getVal('#aug-hflip-p') },
                vflip: { enabled: isEnabled('#aug-vflip-enabled'), p: getVal('#aug-vflip-p') },
                rotate90: { enabled: isEnabled('#aug-rotate90-enabled'), p: getVal('#aug-rotate90-p') },
                rotate: { enabled: isEnabled('#aug-rotate-enabled'), p: getVal('#aug-rotate-p'), limit: getVal('#aug-rotate-limit', 'int') },
                ssr: { enabled: isEnabled('#aug-ssr-enabled'), p: getVal('#aug-ssr-p'), rotate: getVal('#aug-ssr-rotate', 'int'), shift: getVal('#aug-ssr-shift'), scale: getVal('#aug-ssr-scale') },
                affine: { enabled: isEnabled('#aug-affine-enabled'), p: getVal('#aug-affine-p'), shear: getVal('#aug-affine-shear', 'int') },
                crop: { enabled: isEnabled('#aug-crop-enabled'), p: getVal('#aug-crop-p') },
                grayscale: { enabled: isEnabled('#aug-grayscale-enabled'), p: getVal('#aug-grayscale-p') },
                hsv: { enabled: isEnabled('#aug-hsv-enabled'), p: getVal('#aug-hsv-p'), h: getVal('#aug-hsv-h', 'int'), s: getVal('#aug-hsv-s', 'int'), v: getVal('#aug-hsv-v', 'int') },
                bc: { enabled: isEnabled('#aug-bc-enabled'), p: getVal('#aug-bc-p'), b: getVal('#aug-bc-b'), c: getVal('#aug-bc-c') },
                blur: { enabled: isEnabled('#aug-blur-enabled'), p: getVal('#aug-blur-p'), limit: getVal('#aug-blur-limit', 'int') },
                noise: { enabled: isEnabled('#aug-noise-enabled'), p: getVal('#aug-noise-p'), limit: getVal('#aug-noise-limit') },
                cutout: { enabled: isEnabled('#aug-cutout-enabled'), p: getVal('#aug-cutout-p'), holes: getVal('#aug-cutout-holes', 'int'), size: getVal('#aug-cutout-size', 'int') },
                mosaic: { enabled: isEnabled('#aug-mosaic-enabled'), p: getVal('#aug-mosaic-p') }
            };
        }

        // Form Submissions - logic mostly unchanged, just ensuring messages are crisp
        $('#create-dataset-form').on('submit', function(e) {
            e.preventDefault();
            const augmentation_options = getAugmentationOptions('#createDatasetModal');
            const datasetData = {
                description: $('#dataset-description').val(),
                video_uuids: $('#dataset-videos').val(),
                eval_percent: $('#eval-percent').val(),
                test_percent: $('#test-percent').val(),
                augmentation_options: augmentation_options
            };
            $.ajax({
                url: '/createDataset', type: 'POST', contentType: 'application/json',
                data: JSON.stringify(datasetData),
                success: function(response) {
                    if (response.success) {
                        showSuccess('COMPILATION_STARTED');
                        $('#createDatasetModal').modal('hide');
                        refreshDatasets();
                    } else { showError(response.message); }
                },
                error: function(xhr) { showError(xhr.responseJSON ? xhr.responseJSON.message : 'UNKNOWN_ERROR'); }
            });
        });

        $('#upload-video-form').on('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            $.ajax({
                url: '/uploadVideo', type: 'POST', data: formData, processData: false, contentType: false,
                success: function(response) {
                    if (response.success) {
                        showSuccess('UPLOAD_ACKNOWLEDGED. PROCESSING_STREAM...');
                        $('#uploadVideoModal').modal('hide');
                        $(this).trigger('reset');
                        $('.custom-file-label').html('SELECT_DATA_STREAM...');
                        refreshVideos();
                    } else { showError(response.message); }
                }.bind(this),
                error: function(xhr) { showError(xhr.responseJSON ? xhr.responseJSON.message : 'UNKNOWN_ERROR'); }
            });
        });

        $('#import-model-form').on('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            $.ajax({
                url: '/importModel', type: 'POST', data: formData, processData: false, contentType: false,
                success: function(response) {
                    if (response.success) {
                        showSuccess('ENGINE_IMPORTED_SUCCESSFULLY');
                        $('#importModelModal').modal('hide');
                        $(this).trigger('reset');
                        $('.custom-file-label').html('SELECT_FILE...');
                        refreshModels();
                    } else { showError(response.message); }
                }.bind(this),
                error: function(xhr) { showError(xhr.responseJSON ? xhr.responseJSON.message : 'UNKNOWN_ERROR'); }
            });
        });

        $('#settings-form').on('submit', function(e) {
            e.preventDefault();
            const selectedSamOption = $('#setting-sam-model').find('option:selected');
            const classColors = {};
            $('#class-color-manager input[type="color"]').each(function() {
                classColors[$(this).data('class-name')] = $(this).val();
            });

            const settingsData = {
                gpu_device: $('#setting-gpu-device').val(),
                sam_model_checkpoint: selectedSamOption.val(),
                sam_model_name: selectedSamOption.data('name'),
                feature_extractor_model_name: $('#setting-feature-extractor-model').val(),
                sam_mask_confidence: parseFloat($('#setting-sam-mask-confidence').val()),
                nms_iou_threshold: parseFloat($('#setting-nms-iou-threshold').val()),
                prototype_temperature: parseFloat($('#setting-prototype-temperature').val()),
                prototype_sample_limit: parseInt($('#setting-prototype-sample-limit').val()),
                batch_tracking_imgsz: parseInt($('#setting-batch-tracking-imgsz').val()),
                batch_tracking_conf: parseFloat($('#setting-batch-tracking-conf') ? $('#setting-batch-tracking-conf').val() : 0.3),
                batch_tracking_chunk_size: parseInt($('#setting-batch-tracking-chunk-size') ? $('#setting-batch-tracking-chunk-size').val() : 10),
                default_annotation_mode: $('#setting-default-annotation-mode').val(),
                autosave_enabled: $('#setting-autosave-enabled').is(':checked'),
                default_preannotation_conf: parseFloat($('#setting-preannotation-conf').val() || 0.5),
                frame_extraction_jpeg_quality: parseInt($('#setting-jpeg-quality').val()),
                default_opencv_tracker: $('#setting-opencv-tracker').val(),
                cache_save_interval_seconds: parseInt($('#setting-cache-save-interval').val()),
                class_colors: classColors
            };

            $.ajax({
                url: '/api/settings', type: 'POST', contentType: 'application/json',
                data: JSON.stringify(settingsData),
                success: function(response) {
                    if (response.success) {
                         alert(response.restart_required ? "CONFIG_SAVED. RESTART_REQUIRED_FOR_HARDWARE_CHANGES." : "CONFIG_SAVED.");
                    } else { showError(response.message); }
                },
                error: function(xhr) { showError(xhr.responseJSON ? xhr.responseJSON.message : 'UNKNOWN_ERROR'); }
            });
        });

        // Range input value display update
        ['sam-mask-confidence', 'nms-iou-threshold', 'prototype-temperature', 'batch-tracking-conf', 'preannotation-conf'].forEach(id => {
            $(`#setting-${id}`).on('input', function() {
                $(this).closest('.form-group').find('.text-primary').text(parseFloat($(this).val()).toFixed(2));
            });
        });

        $('#clear-cache-btn').on('click', function() {
            if (confirm("CONFIRM: PURGE 'SMART SELECT' CACHE?")) {
                const $btn = $(this);
                $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> PURGING...');
                $.ajax({
                    url: '/api/clear_cache', type: 'POST',
                    success: function(res) { alert(res.message); },
                    complete: function() { $btn.prop('disabled', false).html('<i class="bi bi-eraser-fill"></i> PURGE_CACHE'); }
                });
            }
        });

        $(document).on("click", ".btn-manage-tasks", function() {
            const videoUuid = $(this).data("uuid");
            const videoDesc = $(this).data("description");
            const frameCount = $(this).data("framecount");

            $('#manageTasksModalTitle').text('TASKS_FOR: ' + videoDesc);
            $('#task-video-uuid').val(videoUuid);
            $('#task-start-frame').attr('max', frameCount - 1);
            $('#task-end-frame').attr('max', frameCount - 1);

            refreshTasksInModal(videoUuid);
            $('#manageTasksModal').modal('show');
        });

        function refreshTasksInModal(videoUuid) {
            const taskListBody = $('#task-list-in-modal');
            taskListBody.html('<tr><td colspan="4" class="text-center text-muted"><span class="spinner-border spinner-border-sm"></span> RETRIEVING_DATA...</td></tr>');

            $.get(`/listTasks?video_uuid=${videoUuid}`, function(data) {
                taskListBody.empty();
                if (data.success && data.tasks.length > 0) {
                    data.tasks.forEach(task => {
                        const row = `
                            <tr>
                                <td class="align-middle font-weight-bold font-monospace text-primary">${task.assigned_to}</td>
                                <td class="align-middle font-monospace">${task.start_frame} - ${task.end_frame}</td>
                                <td class="align-middle text-muted small">${task.description || '-'}</td>
                                <td class="align-middle text-right">
                                    <a href="/labelVideo?task_uuid=${task.task_uuid}" class="btn btn-sm btn-primary" title="EXECUTE"><i class="bi bi-pencil-square"></i></a>
                                    <button class="btn btn-sm btn-outline-danger btn-delete-task" data-task-uuid="${task.task_uuid}" data-video-uuid="${videoUuid}"><i class="bi bi-trash"></i></button>
                                </td>
                            </tr>`;
                        taskListBody.append(row);
                    });
                } else {
                    taskListBody.html('<tr><td colspan="4" class="text-center text-muted p-3 font-monospace">NO_ACTIVE_TASKS</td></tr>');
                }
            });
        }

        $('#create-task-form').on('submit', function(e) {
            e.preventDefault();
            const videoUuid = $('#task-video-uuid').val();
            const taskData = {
                video_uuid: videoUuid,
                assigned_to: $('#task-assigned-to').val(),
                description: $('#task-description').val(),
                start_frame: $('#task-start-frame').val(),
                end_frame: $('#task-end-frame').val(),
            };
            $.ajax({
                url: '/createTask', type: 'POST', contentType: 'application/json', data: JSON.stringify(taskData),
                success: function(response) {
                    if (response.success) {
                        $('#create-task-form')[0].reset();
                        refreshTasksInModal(videoUuid);
                    } else { showError(response.message); }
                },
                error: function() { showError('FAILED_TO_ASSIGN_TASK'); }
            });
        });

        $(document).on("click", ".btn-pre-annotate", function() {
            const videoUuid = $(this).data('uuid');
            const frameCount = parseInt($(this).data('frame-count'));
            const labeledCount = parseInt($(this).data('labeled-count'));

            $('#pre-annotate-video-uuid').val(videoUuid).data('frame-count', frameCount).data('labeled-count', labeledCount);
            const modelSelect = $('#pre-annotate-model-select');
            modelSelect.html('<option>SCANNING_MODELS...</option>');

            $('#pre-annotate-start-frame').val(0).attr('max', frameCount - 1);
            $('#pre-annotate-end-frame').val(frameCount - 1).attr('max', frameCount - 1);

            $.get('/listModels', function(data) {
                modelSelect.empty();
                if (data.models && data.models.length > 0) {
                    data.models.forEach(model => {
                        modelSelect.append(`<option value="${model.model_uuid}">${model.description} (${model.model_type})</option>`);
                    });
                } else {
                    modelSelect.append('<option disabled>NO_MODELS_FOUND.</option>');
                }
            });
            $('#preAnnotateModal').modal('show');
        });

        $('#pre-annotate-confidence').on('input', function() { $('#confidence-value').text($(this).val()); });

        $('#pre-annotate-form').on('submit', function(e) {
            e.preventDefault();
            const videoUuid = $('#pre-annotate-video-uuid').val();
            const modelUuid = $('#pre-annotate-model-select').val();
            const labeledCount = parseInt($('#pre-annotate-video-uuid').data('labeled-count'));

            if (!modelUuid) return showError("MODEL_SELECTION_REQUIRED.");

            let msg = "INITIATE AUTO-LABELING SEQUENCE?";
            if (labeledCount > 0 && $('input[name="merge_strategy"]:checked').val() === 'overwrite') {
                msg = `WARNING: ${labeledCount} LABELS DETECTED. OVERWRITE PROTOCOL ACTIVE. PROCEED?`;
            }
            if (!confirm(msg)) return;

            const options = {
                start_frame: $('#pre-annotate-start-frame').val(),
                end_frame: $('#pre-annotate-end-frame').val(),
                confidence: $('#pre-annotate-confidence').val(),
                merge_strategy: $('input[name="merge_strategy"]:checked').val()
            };

            $.ajax({
                url: '/startPreAnnotation', type: 'POST', contentType: 'application/json',
                data: JSON.stringify({ video_uuid: videoUuid, model_uuid: modelUuid, options: options }),
                success: function(response) {
                    if (response.success) {
                        showSuccess('SEQUENCE_STARTED.');
                        $('#preAnnotateModal').modal('hide');
                        refreshVideos();
                    } else { showError(response.message); }
                },
                error: function(xhr) { showError(xhr.responseJSON ? xhr.responseJSON.message : 'UNKNOWN_ERROR'); }
            });
        });

        let videoUuidForImport = null;
        $(document).on("click", ".btn-import-frames", function() {
            videoUuidForImport = $(this).data('uuid');
            $('#frame-import-input').click();
        });

        $('#frame-import-input').on('change', function(e) {
            if (!videoUuidForImport || e.target.files.length === 0) return;
            const formData = new FormData(this);
            formData.append('video_uuid', videoUuidForImport);
            for (let i = 0; i < e.target.files.length; i++) formData.append('frame_files', e.target.files[i]);

            alert(`IMPORTING ${e.target.files.length} FRAMES...`);
            $.ajax({
                url: '/importFrames', type: 'POST', data: formData, processData: false, contentType: false,
                success: function(res) {
                    if(res.success) { showSuccess(`IMPORTED ${res.imported_count} FRAMES.`); refreshVideos(); }
                    else showError(res.message);
                },
                error: function() { showError('IMPORT_ABORTED.'); },
                complete: function() { videoUuidForImport = null; $('#frame-import-input').val(''); }
            });
        });

        // Delete actions - using standard confirm for now
        $(document).on("click", ".btn-delete-video", function() {
            if (confirm('CONFIRM PURGE: DELETE VIDEO AND ALL LABELS?')) {
                $.ajax({ url: '/deleteVideo', type: 'POST', contentType: 'application/json', data: JSON.stringify({ video_uuid: $(this).data('uuid') }), success: refreshVideos });
            }
        });
        $(document).on("click", ".btn-delete-dataset", function() {
            if (confirm('CONFIRM DELETION: DATASET ARCHIVE?')) {
                $.ajax({ url: '/deleteDataset', type: 'POST', contentType: 'application/json', data: JSON.stringify({ dataset_uuid: $(this).data('uuid') }), success: refreshDatasets });
            }
        });
         $(document).on("click", ".btn-delete-model", function() {
            if (confirm('CONFIRM DELETION: INFERENCE ENGINE?')) {
                $.ajax({ url: '/deleteModel', type: 'POST', contentType: 'application/json', data: JSON.stringify({ model_uuid: $(this).data('uuid') }), success: refreshModels });
            }
        });
        $(document).on("click", ".btn-delete-task", function() {
            const videoUuid = $(this).data('video-uuid');
            if (confirm('REVOKE TASK ASSIGNMENT?')) {
                $.ajax({ url: '/deleteTask', type: 'POST', contentType: 'application/json', data: JSON.stringify({ task_uuid: $(this).data('task-uuid') }), success: function() { refreshTasksInModal(videoUuid); } });
            }
        });

        $(document).on("click", ".btn-regenerate-dataset", function() {
            if (confirm('RECOMPILE DATASET? EXISTING FILES WILL BE OVERWRITTEN.')) {
                $.ajax({ url: '/regenerateDataset', type: 'POST', contentType: 'application/json', data: JSON.stringify({ dataset_uuid: $(this).data('uuid') }), success: function(res) { if(res.success){ alert('RECOMPILATION_STARTED.'); refreshDatasets(); } else alert(res.message); } });
            }
        });

        $(document).on("click", ".btn-cancel-task", function() {
            if (confirm('ABORT CURRENT OPERATION?')) {
                $.ajax({ url: '/cancelTask', type: 'POST', contentType: 'application/json', data: JSON.stringify({ video_uuid: $(this).data('uuid') }), success: function(res) { if(res.success){ alert('ABORT_SIGNAL_SENT.'); refreshVideos(); } else alert(res.message); } });
            }
        });

        loadSettings();
        function runAllRefreshes() { refreshVideos(); refreshDatasets(); refreshModels(); }
        runAllRefreshes();
        setInterval(runAllRefreshes, 5000);
    });
</script>
{% endblock %}